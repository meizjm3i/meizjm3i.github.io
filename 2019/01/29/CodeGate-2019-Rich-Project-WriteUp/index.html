<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><title>CodeGate 2019 Rich Project WriteUp [ 梅子酒の笔记本 ]</title><link rel="stylesheet" href="/css/meizj.css"><link rel="stylesheet" href="/css/prettify.css"><link rel="stylesheet" href="/css/tomorrow-night-blue.css"><script src="https://cdn.bootcss.com/jquery/3.4.0/jquery.min.js"></script></head><body><div id="menu-outer"><nav id="menu-inner"><a id="menuLabel" href="/">Home</a><a id="menuLabel" href="/about">About</a><a id="menuLabel" href="/archives">Archives</a><a id="menuLabel" href="https://github.com/meizjm3i">Github</a></nav></div><div id="content-outer"><div id="content-inner"><div id="recent-posts"><a id="blogTitle">Meizj's Blog</a></div><article id="post"><h1 id="postTitle">CodeGate 2019 Rich Project WriteUp</h1><h1 id="codegate2019-rich-project-writeup"><a class="markdownIt-Anchor" href="#codegate2019-rich-project-writeup"></a> CodeGate2019  Rich Project Writeup</h1>
<p>题目提供了一个普通的页面，注册登录后，提示我们有足额金币后，会给我们&quot;GOOD THINGS&quot;，然而注册只提供10000的金币。</p>
<p><img src="/img/codegate2019-1.jpg" alt></p>
<p>扫了下敏感文件，有robots.txt，发现top_secret.zip文件，下载下来，是个加密的zip文件，看了下文件列表:<br>
<img src="/img/codegate2019-2.jpg" alt></p>
<p>发现最后有一个空的文件&quot;ZIP PASS = MASTER_PW&quot;，尝试明文攻击。</p>
<p>但是pkcrack给了error:</p>
<p><img src="/img/codegate2019-3.jpg" alt></p>
<p>换用rbkcrack就解决了，随后又找到了<code>MASTER_PW</code>，把所有文件解压后，看到<code>flag.php</code>的内容为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$key= <span class="string">"D0_N0T_RE1E@5E_0THER5"</span>;</span><br><span class="line">	$FLAG = <span class="string">"##########"</span></span><br><span class="line">	<span class="keyword">if</span>($_GET[<span class="string">'key'</span>] === $key)</span><br><span class="line">		<span class="keyword">die</span>($FLAG);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"who you are?"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>并且，<code>info</code>页面的<code>GOOD THINGS</code>会跳转到<code>pay.php</code>，而<code>pay.php</code>的内容为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="container" style="margin-top:120px"&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'ID'</span>]))</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'login first'</span>);</span><br><span class="line">	$conn = dbconn(<span class="string">'tradedata'</span>);</span><br><span class="line">	$q = <span class="string">"SELECT * FROM user_wallet where id='&#123;$_SESSION['ID']&#125;'"</span>;</span><br><span class="line">	$res = mysqli_query($conn,$q);</span><br><span class="line">	$row = mysqli_fetch_array($res);</span><br><span class="line">	<span class="keyword">if</span>($row[<span class="string">'cash'</span>] &lt;<span class="number">999999999</span>)</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"Not enough gold"</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">include</span> <span class="string">'../__SECRET__/flag.php'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>因此找到一个注入点即可完成攻击。</p>
<p>看了下与<code>coin</code>直接相关的交易逻辑<code>reserv.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="container" style="margin-top:120px"&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $MASTER_PW = <span class="string">"D0_N0T_RE1E@5E_0THER5"</span>; <span class="comment">#Already you know this, right?</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'ID'</span>]))</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"login first"</span>);</span><br><span class="line">	<span class="keyword">if</span>($_SESSION[<span class="string">'ID'</span>] ==<span class="string">"admin"</span>)</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Fobbiden account'</span>);</span><br><span class="line"></span><br><span class="line">	$time = strtotime($_POST[<span class="string">'date'</span>]);</span><br><span class="line">	<span class="keyword">if</span>($time === <span class="keyword">NULL</span> || $time &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"detect input error"</span>);</span><br><span class="line">	<span class="keyword">if</span>($time &lt; time() || $time &gt; time()+<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>*<span class="number">365</span>*<span class="number">20</span>)</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"detect input error"</span>);</span><br><span class="line">	$count = addslashes($_POST[<span class="string">'amount'</span>]);</span><br><span class="line">	<span class="keyword">if</span>($count &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"Invalid input"</span>);</span><br><span class="line">	<span class="keyword">if</span>($_POST[<span class="string">'code'</span>] !== $MASTER_PW)</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"Input reserv password"</span>);</span><br><span class="line"></span><br><span class="line">	$conn = dbconn(<span class="string">'tradedata'</span>);</span><br><span class="line">	$q = <span class="string">"SELECT * FROM user_wallet where id = '&#123;$_SESSION['ID']&#125;'"</span>;</span><br><span class="line">	$res = mysqli_query($conn,$q);</span><br><span class="line">	$row = mysqli_fetch_assoc($res);</span><br><span class="line"></span><br><span class="line">	$q = <span class="string">"UPDATE user_wallet SET reserv=from_unixtime(&#123;$time&#125;),amount='&#123;$count&#125;' where id='&#123;$_SESSION['ID']&#125;'"</span>;</span><br><span class="line">	mysqli_query($conn,$q);</span><br><span class="line">	mysqli_commit($conn);</span><br><span class="line">	header(<span class="string">'Location: ./?p=market'</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>发现只要能绕过对<code>$time</code>的检测即可，而对<code>$time</code>的检测又十分的简单，因此可以直接控制<code>$amount</code>，甚至连注入都不需要进行，直接POST数据便能触发攻击。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">date=2019-11-11&amp;amount=100000000000&amp;code=D0_N0T_RE1E@5E_0THER5</span><br></pre></td></tr></table></figure>
<p>攻击完成效果:<br>
<img src="/img/codegate2019-4.jpg" alt></p>
<p>带上<code>key</code>访问<code>/?p=pay</code>页面，拿到<code>Flag</code></p>
<p><img src="/img/codegate2019-5.jpg" alt></p>
</article><div id="paginator"></div></div></div><div id="footer"><div id="bottom-inner"><span>Powerd By </span><span> Meizj </span><span>using    </span><a href="https://github.com/meizjm3i/Meizj"><span>Meizj</span></a><span>.</span><br></div></div><script src="/js/prettify.js"></script><script>$(window).on('load', function(){ 
$('pre').addClass('prettyprint linenums');
prettyPrint();
});
$(".gutter").remove();</script></body></html>