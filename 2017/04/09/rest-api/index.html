<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><title>CVE-2017-5487:Content Injection Vulnerability in WordPress 4.7 and 4.7.1 [ 梅子酒の笔记本 ]</title><link rel="stylesheet" href="/css/meizj.css"><link rel="stylesheet" href="/css/prettify.css"><link rel="stylesheet" href="/css/tomorrow-night-blue.css"><script src="https://cdn.bootcss.com/jquery/3.4.0/jquery.min.js"></script></head><body><div id="menu-outer"><nav id="menu-inner"><a id="menuLabel" href="/">Home</a><a id="menuLabel" href="/about">About</a><a id="menuLabel" href="/archives">Archives</a><a id="menuLabel" href="https://github.com/meizjm3i">Github</a></nav></div><div id="content-outer"><div id="content-inner"><div id="recent-posts"><a id="blogTitle">Meizj's Blog</a></div><article id="post"><h1 id="postTitle">CVE-2017-5487:Content Injection Vulnerability in WordPress 4.7 and 4.7.1</h1><p>最近在漏洞盒子上提交了两个wordpress的REST API的越权漏洞，现在做一下学习总结</p>
<ol>
<li></li>
</ol>
<p>REST全称是REpresentational State Transfer，即表述性状态转移.</p>
<p>换个角度看，REST API首先是个API，它与普通API不同的地方在于它是可以通过URL来完成操作的，这样就极大地方便了前端，但同时问题就出来了，如果任意访问者都可使用REST API则会形成越权漏洞，在Wordpress的这个漏洞中不需要任何权限，只是通过简单的更改URL和Content-Type就可以实现更改页面内容</p>
<ol start="2">
<li></li>
</ol>
<p>在知道了这个漏洞的成因之后，我们需要知道REST API操作资源的方式，然后在包含该漏洞的网页上操作即可。</p>
<p>REST API通过GET,POST,PUT,DELETE,Options，Head来操作资源，并且post后面并不需要具体的路径，比如你想访问id为32的文章，一般方法是 ?id=32 ，但是post只需要32就可以了。</p>
<p>在有漏洞存在可能的网页上输入url:/wp-json/wp/v2/posts，如果返回的是json类数据，那么很有可能存在漏洞，如图：</p>
<p><img src="http://www.meizj.com.cn/wp-content/uploads/2017/03/Inked1_LI.jpg" alt></p>
<p>接下来就是找定id，利用api姿势来修改特定内容，这里不做过多说明(っ´Ι`)っ</p>
<p>3.分析</p>
<p>去下了份wp4.7.1，开始看REST API相关源码分析漏洞成因。</p>
<p>首先分析漏洞是属于权限认证失误导致越权漏洞，将目标缩小到权限检查函数，再结合目前利用最多的方式看，应该是在对数据更新这一块的权限认证产生了漏洞，打开wp有关rest pai的源码进行分析。</p>
<p>在漏洞利用的过程中，我们通过构造一个url来进行检验，这个步骤通过注册路由来实现，而我们在\wp-wpincludes\rest-api\endpoints\class-wp-rest-posts-controller.php开头处便发现了一个名为register_routes的功能，再往下看找到更新数据的register_rest_route，发现有个正则表达式生成，这里经过看其他大大的测试以及自己的复现，发现<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mrow></mrow><mi>G</mi></msub><mi>E</mi><mi>T</mi><mi mathvariant="normal">和</mi></mrow><annotation encoding="application/x-tex">_GET和</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">G</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord cjk_fallback">和</span></span></span></span>_POST的优先级确实高于正则生成的优先级，所以可以直接将这个正则忽略掉，往下看，里面调用了update_item以及update_item_permissions_check两个函数。<img src="http://www.meizj.com.cn/wp-content/uploads/2017/04/1.png" alt></p>
<p>猜测逻辑为，先进行权限检查再进行数据更新，若权限检查失败，则不进行数据更新，也就是说，漏洞的源头在update_item_permissions_check中。</p>
<p>在该文件中查找这两个函数。</p>
<p><img src="http://www.meizj.com.cn/wp-content/uploads/2017/04/2-1.png" alt></p>
<p>大概阅读一下，该函数由四个if以及开头两个函数组成，若想达成权限绕过的目的，突破口便在第一个if的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mi>t</mi><mi mathvariant="normal">上</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">使</mi><mi>g</mi><mi>e</mi><msub><mi>t</mi><mi>i</mi></msub><mi>n</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">post上，使get_inistance(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord cjk_fallback">上</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">使</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">e</span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">n</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span><span class="mopen">(</span></span></span></span>post)返回false即可达到绕过的目的，跟进get_post函数，</p>
<p><img src="http://www.meizj.com.cn/wp-content/uploads/2017/04/3-1.png" alt></p>
<p>首先<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mi>t</mi><mi mathvariant="normal">不</mi><mi mathvariant="normal">为</mi><mi mathvariant="normal">空</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">过</mi><mi mathvariant="normal">第</mi><mi mathvariant="normal">一</mi><mi mathvariant="normal">个</mi><mi>i</mi><mi>f</mi><mi mathvariant="normal">，</mi></mrow><annotation encoding="application/x-tex">post不为空，过第一个if，</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord cjk_fallback">不</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">空</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">过</span><span class="mord cjk_fallback">第</span><span class="mord cjk_fallback">一</span><span class="mord cjk_fallback">个</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord cjk_fallback">，</span></span></span></span>post不是WP_POST的对象，过第二个，进第三个，先不忙着跟进get_inistance方法，继续向下阅读，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mrow></mrow><mi>p</mi></msub><mi>o</mi><mi>s</mi><mi>t</mi><mi mathvariant="normal">不</mi><mi mathvariant="normal">为</mi><mi mathvariant="normal">空</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">过</mi><mi mathvariant="normal">第</mi><mi mathvariant="normal">四</mi><mi mathvariant="normal">个</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">接</mi><mi mathvariant="normal">下</mi><mi mathvariant="normal">来</mi><mi mathvariant="normal">就</mi><mi mathvariant="normal">是</mi><mi mathvariant="normal">的</mi><mi mathvariant="normal">几</mi><mi mathvariant="normal">个</mi><mi mathvariant="normal">函</mi><mi mathvariant="normal">数</mi><mi mathvariant="normal">都</mi><mi mathvariant="normal">很</mi><mi mathvariant="normal">简</mi><mi mathvariant="normal">单</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">最</mi><mi mathvariant="normal">后</mi><mi mathvariant="normal">就</mi><mi mathvariant="normal">是</mi><mi mathvariant="normal">返</mi><mi mathvariant="normal">回</mi></mrow><annotation encoding="application/x-tex">_post不为空，过第四个，接下来就是的几个函数都很简单，最后就是返回</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord cjk_fallback">不</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">空</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">过</span><span class="mord cjk_fallback">第</span><span class="mord cjk_fallback">四</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">接</span><span class="mord cjk_fallback">下</span><span class="mord cjk_fallback">来</span><span class="mord cjk_fallback">就</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">几</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">函</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">都</span><span class="mord cjk_fallback">很</span><span class="mord cjk_fallback">简</span><span class="mord cjk_fallback">单</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">最</span><span class="mord cjk_fallback">后</span><span class="mord cjk_fallback">就</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">返</span><span class="mord cjk_fallback">回</span></span></span></span>_post ,现在跟进get_inistance方法，</p>
<p><img src="http://www.meizj.com.cn/wp-content/uploads/2017/04/4.png" alt></p>
<p>第一个if语句判断<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi><msub><mi>t</mi><mi>i</mi></msub><mi>d</mi><mi mathvariant="normal">是</mi><mi mathvariant="normal">不</mi><mi mathvariant="normal">是</mi><mi mathvariant="normal">整</mi><mi mathvariant="normal">数</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">如</mi><mi mathvariant="normal">果</mi><mi mathvariant="normal">不</mi><mi mathvariant="normal">是</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">则</mi><mi mathvariant="normal">返</mi><mi mathvariant="normal">回</mi><mi>f</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>e</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">划</mi><mi mathvariant="normal">重</mi><mi mathvariant="normal">点</mi><mi mathvariant="normal">！</mi><mi mathvariant="normal">！</mi><mi mathvariant="normal">这</mi><mi mathvariant="normal">里</mi><mi mathvariant="normal">就</mi><mi mathvariant="normal">可</mi><mi mathvariant="normal">以</mi><mi mathvariant="normal">返</mi><mi mathvariant="normal">回</mi><mi>f</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>e</mi><mi mathvariant="normal">了</mi><mi mathvariant="normal">！</mi><mi mathvariant="normal">！</mi><mi mathvariant="normal">也</mi><mi mathvariant="normal">就</mi><mi mathvariant="normal">是</mi><mi mathvariant="normal">说</mi><mi mathvariant="normal">我</mi><mi mathvariant="normal">们</mi><mi mathvariant="normal">只</mi><mi mathvariant="normal">要</mi><mi mathvariant="normal">使</mi></mrow><annotation encoding="application/x-tex">post_id是不是整数，如果不是，则返回false，划重点！！这里就可以返回false了！！也就是说我们只要使</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">d</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">不</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">整</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">如</span><span class="mord cjk_fallback">果</span><span class="mord cjk_fallback">不</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">则</span><span class="mord cjk_fallback">返</span><span class="mord cjk_fallback">回</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">划</span><span class="mord cjk_fallback">重</span><span class="mord cjk_fallback">点</span><span class="mord cjk_fallback">！</span><span class="mord cjk_fallback">！</span><span class="mord cjk_fallback">这</span><span class="mord cjk_fallback">里</span><span class="mord cjk_fallback">就</span><span class="mord cjk_fallback">可</span><span class="mord cjk_fallback">以</span><span class="mord cjk_fallback">返</span><span class="mord cjk_fallback">回</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord cjk_fallback">了</span><span class="mord cjk_fallback">！</span><span class="mord cjk_fallback">！</span><span class="mord cjk_fallback">也</span><span class="mord cjk_fallback">就</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">说</span><span class="mord cjk_fallback">我</span><span class="mord cjk_fallback">们</span><span class="mord cjk_fallback">只</span><span class="mord cjk_fallback">要</span><span class="mord cjk_fallback">使</span></span></span></span>post_id不为整数即可绕过权限检查。</p>
<p>绕过权限检查之后，会进入update_item函数，</p>
<p><img src="http://www.meizj.com.cn/wp-content/uploads/2017/04/5.png" alt></p>
<p>可以看到开头就是一个int类型转换，再联系到php的弱类型转换,123qwe经过转换就是123，也就是是说，请求id为123qwe时，绕过权限检查，并且能对id为123的文章进行操作。</p>
<p>至此漏洞分析结束。</p>
<p>因为这个分析主要是复现学习作用，所以参考了蛮多其他大牛的分析过程，所以大体思路会有些眼熟，就这样了，睡觉。</p>
<p><del>（注意这个洞是部分4.7.1和4.7.0含有的，想复现的小伙伴啊。。。。。</del></p>
</article><div id="paginator"></div></div></div><div id="footer"><div id="bottom-inner"><span>Powerd By </span><span> Meizj </span><span>using    </span><a href="https://github.com/meizjm3i/Meizj"><span>Meizj</span></a><span>.</span><br></div></div><script src="/js/prettify.js"></script><script>$(window).on('load', function(){ 
$('pre').addClass('prettyprint linenums');
prettyPrint();
});
$(".gutter").remove();</script></body></html>