<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <link rel="stylesheet" href="//unpkg.com/heti/umd/heti.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&family=Roboto+Serif:opsz,wght@8..144,100&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        梅子酒の笔记本
    </title>
    <link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">
    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css">
<link rel="alternate" href="/atom.xml" title="梅子酒の笔记本" type="application/atom+xml">
</head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            从0CTF分析move_uploaded_file函数的一个特点
        </p>
        <hr>
    </div>
    <div class="post-content heti">
        <p>上周的0CTF中有道题，其中涉及到了文件上传，并用到了move_uploaded_file()函数，这里给出关键代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">'upload'</span>:</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">"name"</span>]) || !<span class="keyword">isset</span>($_FILES[<span class="string">'file'</span>])) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($_FILES[<span class="string">'file'</span>][<span class="string">'size'</span>] &gt; <span class="number">100000</span>) &#123;</span><br><span class="line">      clear($dir);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $name = $dir . $_GET[<span class="string">"name"</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/[^a-zA-Z0-9.\/]/"</span>, $name) || stristr(pathinfo($name)[<span class="string">"extension"</span>], <span class="string">"h"</span>)) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"fail3\n"</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>], $name);</span><br><span class="line">    $size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (scandir($dir) <span class="keyword">as</span> $file) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_array($file, [<span class="string">"."</span>, <span class="string">".."</span>])) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      $size += filesize($dir . $file);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($size &gt; <span class="number">100000</span>) &#123;</span><br><span class="line">      clear($dir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>可以看到,这里先是对后缀名进行了过滤，再去进行move_uploaded_file操作,对于这一步的绕过,一开始很多人都构造成了 name=index.php/.  这种格式，但是会发现，这样虽然绕过了后缀检查.<br>
其中,假如我们传入的是 name=aaa.php/.  ,则能够正常生成 aaa.php,而传入index.php/.则在覆盖文件这一步失败了，然后从这里就产生了差异，开始有了不同的解法。</p>
<p>据我所知有三种:</p>
<ol>
<li>时间竞争</li>
<li>上传.bin文件，执行opcache文件</li>
<li>使用其他格式的name去覆盖文件</li>
</ol>
<p>其中，我是第三个.继续构造name字段,最终使用 name=aaa/…/index.php/.  成功绕过并覆盖文件。</p>
<p>但是这里很容易产生一个疑问,为什么  name=index.php/.  和  name=aaa/…/index.php/.  产生了不同的效果？</p>
<p>赛后我进行了本地复现，测试目录结构为:</p>
<p><img src="https://s2.ax1x.com/2019/06/27/Zn5yJe.png" alt></p>
<p>其中index.html为上传页面，源码为:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">content</span>=<span class="string">"width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"index.php?name=aaa/../index.php/."</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>index.php为上传处理页面，源码为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$path= <span class="string">"./upload/"</span>;</span><br><span class="line">$name = $path.$_GET[<span class="string">'name'</span>];</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/[^a-zA-Z0-9.\/]/"</span>, $name) || stristr(pathinfo($name)[<span class="string">"extension"</span>], <span class="string">"h"</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"unsafe"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $name.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span>(move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>], $name))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"failed"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>upload目录下的index.php为空。</p>
<p>首先测试的是name=index.php/.的情况:</p>
<p><img src="https://s2.ax1x.com/2019/06/27/Zn56RH.png" alt></p>
<p>然后是name=aaa/…/index.php/.的情况:</p>
<p><img src="https://s2.ax1x.com/2019/06/27/Zn52QA.png" alt></p>
<p>处理结果和测试预期结果一致，其中我担心是php版本所导致的不同，分别拿php5.6.31、php7.0.22、7.1.0三个版本进行了试验，得到的结果均一样，可以排除是php版本所造成的差异。</p>
<p>在上面的两个测试中，可以发现name=index.php/.的错误信息是No Such file or Directory，而name=aaa/…/index.php/.则没有报错，因此初步猜测是move_uploaded_file对于经过了目录跳转后的文件判断机制发生了变化，这一块就需要跟进源码查看。</p>
<p>然后寻找move_uploaded_file的源码，源码位置为/ext/standard/basic_functions.c，源码如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(move_uploaded_file)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *path, *new_path;</span><br><span class="line">	<span class="keyword">int</span> path_len, new_path_len;</span><br><span class="line">	zend_bool successful = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PHP_WIN32</span></span><br><span class="line">	<span class="keyword">int</span> oldmask; <span class="keyword">int</span> ret;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!SG(rfc1867_uploaded_files)) &#123;</span><br><span class="line">		RETURN_FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">"sp"</span>, &amp;path, &amp;path_len, &amp;new_path, &amp;new_path_len) == FAILURE) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!zend_hash_exists(SG(rfc1867_uploaded_files), path, path_len + <span class="number">1</span>)) &#123;</span><br><span class="line">		RETURN_FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (php_check_open_basedir(new_path TSRMLS_CC)) &#123;</span><br><span class="line">		RETURN_FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (VCWD_RENAME(path, new_path) == <span class="number">0</span>) &#123;</span><br><span class="line">		successful = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PHP_WIN32</span></span><br><span class="line">		oldmask = umask(<span class="number">077</span>);</span><br><span class="line">		umask(oldmask);</span><br><span class="line"></span><br><span class="line">		ret = VCWD_CHMOD(new_path, <span class="number">0666</span> &amp; ~oldmask);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">			php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING, <span class="string">"%s"</span>, strerror(errno));</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (php_copy_file_ex(path, new_path, STREAM_DISABLE_OPEN_BASEDIR TSRMLS_CC) == SUCCESS) &#123;</span><br><span class="line">		VCWD_UNLINK(path);</span><br><span class="line">		successful = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (successful) &#123;</span><br><span class="line">		zend_hash_del(SG(rfc1867_uploaded_files), path, path_len + <span class="number">1</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING, <span class="string">"Unable to move '%s' to '%s'"</span>, path, new_path);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	RETURN_BOOL(successful);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中第一种payload最终执行到了这一句：</p>
<blockquote>
<p>php_error_docref(NULL TSRMLS_CC, E_WARNING, “Unable to move ‘%s’ to ‘%s’”, path, new_path);</p>
</blockquote>
<p>因此 successful变量的值为0，因此可能是VCWD_RENAME或者php_copy_file_ex导致的问题，先跟进VCWD_RENAME，找到三处定义部分:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(TSRM_WIN32)</span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> VCWD_RENAME(oldname, newname) (MoveFileEx(oldname, newname, MOVEFILE_REPLACE_EXISTING|MOVEFILE_COPY_ALLOWED) == 0 ? -1 : 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> VCWD_RENAME(oldname, newname) rename(oldname, newname)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VCWD_RENAME(oldname, newname) virtual_rename(oldname, newname TSRMLS_CC)</span></span><br></pre></td></tr></table></figure>
<p>但是在virtual_rename的定义中，也是通过TSRM_WIN32来看情况调用MoveFileEx和rename的，因此最终调用的函数仍然是rename(oldname,newname)，因此猜测是linux c的rename导致的问题。</p>
<p>然后写了个C来验证:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> oldname[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">char</span> newname[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"old:"</span>);</span><br><span class="line">    gets(oldname);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"new:"</span>);</span><br><span class="line">    gets(newname);</span><br><span class="line">    <span class="keyword">if</span> (rename(oldname, newname) == <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"change %s to %s.\n"</span>, oldname, newname);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        perror(<span class="string">"rename"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而得到的结果是两种payload都失败了，也就是说，并不是rename引起的问题。</p>
<p>因此能确定是php_copy_file_ex导致的问题了，php_copy_file_ex定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PHPAPI <span class="keyword">int</span> <span class="title">php_copy_file_ex</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *src, <span class="keyword">const</span> <span class="keyword">char</span> *dest, <span class="keyword">int</span> src_flg TSRMLS_DC)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> php_copy_file_ctx(src, dest, <span class="number">0</span>, <span class="literal">NULL</span> TSRMLS_CC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>php_copy_file_ctx定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PHPAPI <span class="keyword">int</span> <span class="title">php_copy_file_ctx</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *src, <span class="keyword">const</span> <span class="keyword">char</span> *dest, <span class="keyword">int</span> src_flg, php_stream_context *ctx TSRMLS_DC)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	php_stream *srcstream = <span class="literal">NULL</span>, *deststream = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> ret = FAILURE;</span><br><span class="line">	php_stream_statbuf src_s, dest_s;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (php_stream_stat_path_ex(src, <span class="number">0</span>, &amp;src_s, ctx)) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">			<span class="comment">/* non-statable stream */</span></span><br><span class="line">			<span class="keyword">goto</span> safe_to_copy;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>: <span class="comment">/* failed to stat file, does not exist? */</span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (S_ISDIR(src_s.sb.st_mode)) &#123;</span><br><span class="line">		php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING, <span class="string">"The first argument to copy() function cannot be a directory"</span>);</span><br><span class="line">		<span class="keyword">return</span> FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (php_stream_stat_path_ex(dest, PHP_STREAM_URL_STAT_QUIET | PHP_STREAM_URL_STAT_NOCACHE, &amp;dest_s, ctx)) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">			<span class="comment">/* non-statable stream */</span></span><br><span class="line">			<span class="keyword">goto</span> safe_to_copy;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>: <span class="comment">/* failed to stat file, does not exist? */</span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (S_ISDIR(dest_s.sb.st_mode)) &#123;</span><br><span class="line">		php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING, <span class="string">"The second argument to copy() function cannot be a directory"</span>);</span><br><span class="line">		<span class="keyword">return</span> FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!src_s.sb.st_ino || !dest_s.sb.st_ino) &#123;</span><br><span class="line">		<span class="keyword">goto</span> no_stat;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (src_s.sb.st_ino == dest_s.sb.st_ino &amp;&amp; src_s.sb.st_dev == dest_s.sb.st_dev) &#123;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">goto</span> safe_to_copy;</span><br><span class="line">	&#125;</span><br><span class="line">no_stat:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> *sp, *dp;</span><br><span class="line">		<span class="keyword">int</span> res;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ((sp = expand_filepath(src, <span class="literal">NULL</span> TSRMLS_CC)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ((dp = expand_filepath(dest, <span class="literal">NULL</span> TSRMLS_CC)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			efree(sp);</span><br><span class="line">			<span class="keyword">goto</span> safe_to_copy;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		res =</span><br><span class="line">#ifndef PHP_WIN32</span><br><span class="line">			!<span class="built_in">strcmp</span>(sp, dp);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">			!strcasecmp(sp, dp);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		efree(sp);</span><br><span class="line">		efree(dp);</span><br><span class="line">		<span class="keyword">if</span> (res) &#123;</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">safe_to_copy:</span><br><span class="line"></span><br><span class="line">	srcstream = php_stream_open_wrapper_ex(src, <span class="string">"rb"</span>, src_flg | REPORT_ERRORS, <span class="literal">NULL</span>, ctx);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!srcstream) &#123;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	deststream = php_stream_open_wrapper_ex(dest, <span class="string">"wb"</span>, REPORT_ERRORS, <span class="literal">NULL</span>, ctx);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (srcstream &amp;&amp; deststream) &#123;</span><br><span class="line">		ret = php_stream_copy_to_stream_ex(srcstream, deststream, PHP_STREAM_COPY_ALL, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (srcstream) &#123;</span><br><span class="line">		php_stream_close(srcstream);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (deststream) &#123;</span><br><span class="line">		php_stream_close(deststream);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为我们已经知道两种payload会产生差异，因此可以倒推，ret在某个地方值发生了变化，因此可以知道是执行到了这一步:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = php_stream_copy_to_stream_ex(srcstream, deststream, PHP_STREAM_COPY_ALL, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>
<p>然后继续跟入定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> php_stream_copy_to_stream_ex(src, dest, maxlen, len)	_php_stream_copy_to_stream_ex((src), (dest), (maxlen), (len) STREAMS_CC TSRMLS_CC)</span></span><br></pre></td></tr></table></figure>
<p>然后继续跟入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PHPAPI <span class="keyword">int</span> _php_stream_copy_to_stream_ex(php_stream *src, php_stream *dest, <span class="keyword">size_t</span> maxlen, <span class="keyword">size_t</span> *len STREAMS_DC TSRMLS_DC)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (php_stream_stat(src, &amp;ssbuf) == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (ssbuf.sb.st_size == <span class="number">0</span></span><br><span class="line">#ifdef S_ISREG</span><br><span class="line">			&amp;&amp; S_ISREG(ssbuf.sb.st_mode)</span><br><span class="line">#endif</span><br><span class="line">		) &#123;</span><br><span class="line">			*len = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">return</span> SUCCESS;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>到这里为止，关键代码已经可以看到了，这里使用了php_stream_stat去进行判断，因此直接在php里面查看一下文件信息进行确认:</p>
<p><img src="https://s2.ax1x.com/2019/06/27/Zn5czd.png" alt></p>
<p>得到确认，在进行了目录跳转后，move_uploaded_file将文件判断为不存在了，因此能够执行覆盖操作。</p>

    </div>

    
</div>
    <div class="footer" id="footer">
    <p>Copyright © 2020 Meizj.
        <!-- <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label> -->
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="white">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">
<script src="/libs/jquery.min.js"></script>
<script src="/libs/highlight/highlight.pack.js"></script>
<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script src="//unpkg.com/heti/umd/heti-addon.min.js"></script>
<script>
    const heti = new Heti('.heti');
    heti.autoSpacing();
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5JET59Z93Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5JET59Z93Q');
</script>
<script src="/js/js.js"></script>
<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>