<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <!-- <link rel="stylesheet" href="//unpkg.com/heti/umd/heti.min.css" /> -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <meta name="google-site-verification" content="4cHoOS7NWlC69R13-vSl7CNSFo2WPB_nCvwPBiQoSZI">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&family=Roboto+Serif:opsz,wght@8..144,100&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        梅子酒の笔记本
    </title>
    <link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">
    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css">
<link rel="alternate" href="/atom.xml" title="梅子酒の笔记本" type="application/atom+xml">
</head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            RIPS源码精读(一):逻辑流程及lib文件夹大致说明
        </p>
        <hr>
    </div>
    <div class="post-content heti">
        <blockquote>
<p>很早就有深入分析学习一款源代码审计工具的想法，在查找rips源码分析相关资料时，发现相关的学习分析资料较少，于是选择rips作为该系列文章的分析对象，因为没有最新版的rips的源码，因此选取的rips源码为已公开的版本。<br>
因为我是第一次将具体的分析写下来，并且本身的技术能力问题，在某些场景下的用语或者技术细节描述可能存在偏差，请师傅们包涵。</p>
</blockquote>
<h2 id="引言"><a class="markdownIt-Anchor" href="#引言"></a> 引言</h2>
<p>RIPS是一个源代码分析工具，它使用了静态分析技术，能够自动化地挖掘PHP源代码潜在的安全漏洞</p>
<h2 id="本篇内容"><a class="markdownIt-Anchor" href="#本篇内容"></a> 本篇内容</h2>
<p>作为本系列文章的开始，只介绍rips的逻辑流程以及lib文件夹下各文件大致内容分析，不具体分析代码审计的细节，相关细节在之后的文章中分析</p>
<h2 id="整体结构"><a class="markdownIt-Anchor" href="#整体结构"></a> 整体结构</h2>
<p>RIPS工具的整体架构如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">+-- CHANGELOG [file]</span><br><span class="line">+-- config [dir]</span><br><span class="line">|	+-- general.php</span><br><span class="line">|	+-- help.php</span><br><span class="line">|	+-- info.php</span><br><span class="line">|	+-- securing.php</span><br><span class="line">|	+-- sinks.php</span><br><span class="line">|	+-- sources.php</span><br><span class="line">|	+-- tokens.php</span><br><span class="line">+-- css [dir]</span><br><span class="line">|	+-- ayti.css</span><br><span class="line">|	+-- barf.css</span><br><span class="line">|	+-- code-dark.css</span><br><span class="line">|	+-- espresso.css</span><br><span class="line">|	+-- notepad++.css</span><br><span class="line">|	+-- phps.css</span><br><span class="line">|	+-- print.css</span><br><span class="line">|	+-- rips.css</span><br><span class="line">|	+-- rips.png</span><br><span class="line">|	+-- scanning.gif</span><br><span class="line">|	+-- term.css</span><br><span class="line">|	+-- twlight.css</span><br><span class="line">+-- index.php [file]</span><br><span class="line">+-- js [dir]</span><br><span class="line">|	+-- exploit.js</span><br><span class="line">|	+-- hotpatch.js</span><br><span class="line">|	+-- netron.js</span><br><span class="line">|	+-- script.js</span><br><span class="line">+-- lib [dir]</span><br><span class="line">|	+-- analyzer.php</span><br><span class="line">|	+-- constructer.php</span><br><span class="line">|	+-- filer.php</span><br><span class="line">|	+-- printer.php</span><br><span class="line">|	+-- scanner.php</span><br><span class="line">|	+-- searcher.php</span><br><span class="line">|	+-- tokenizer.php</span><br><span class="line">+-- LICENSE [file]</span><br><span class="line">+-- main.php [file]</span><br><span class="line">+-- README.md [file]</span><br><span class="line">+-- windows [dir]</span><br><span class="line">|	+-- code.php</span><br><span class="line">|	+-- exploit.php</span><br><span class="line">|	+-- function.php</span><br><span class="line">|	+-- help.php</span><br><span class="line">|	+-- hotpatch.php</span><br><span class="line">|	+-- leakscan.php</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">config目录:放置各种配置信息</span><br><span class="line"></span><br><span class="line">css目录:放置css样式文件</span><br><span class="line"></span><br><span class="line">js目录:放置js代码文件</span><br><span class="line"></span><br><span class="line">lib目录:rips的核心代码文件</span><br><span class="line"></span><br><span class="line">window:rips的前端构成</span><br></pre></td></tr></table></figure>
<h2 id="lib文件夹说明"><a class="markdownIt-Anchor" href="#lib文件夹说明"></a> lib文件夹说明</h2>
<p>lib文件夹存放rips运行的核心文件,定义了大量函数以及类用以完成rips完整的代码分析功能</p>
<ol>
<li>analyzer.php</li>
</ol>
<blockquote>
<p>仅定义了<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">2. constructer.php</span><br><span class="line">&gt; 本文件定义了五个类,分别为```VarDeclare```、```VulnBlock```、```VulnTreeNode```、```InfoTreeNode```、```FunctionDeclare```,分别用以```存储变量```、```漏洞总干```、```每个漏洞具体信息```、```存储信息```、```存储函数</span><br></pre></td></tr></table></figure></p>
</blockquote>
<ol start="3">
<li>filer.php</li>
</ol>
<blockquote>
<p>仅定义了函数<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">4. printer.php</span><br><span class="line">&gt; 定义大量函数,基本都是用于将分析得到的结果输出至前端页面</span><br><span class="line">5. scanner.php</span><br><span class="line">&gt; 仅定义了```scanner```类,类中包含大量方法,本文件为rips分析操作的核心文件，包括token处理、字段处理等功能</span><br><span class="line">6. searcher.php</span><br><span class="line">&gt; 仅定义了```searchFile```函数,主要用于根据token信息分析漏洞情况，并使用```VulnTreeNode```类加以实例化</span><br><span class="line">7. tokenizer.php</span><br><span class="line">&gt; 仅定义了```Tokenizer```类,类中定义大量函数,其余文件中所用到的token信息均来源于此文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## index.php 分析</span><br><span class="line"></span><br><span class="line">index.php是rips项目的入口文件，因此我放在了第一个分析。</span><br><span class="line"></span><br><span class="line">代码构成主要是前端文件，功能方面主要将目标路径、扫描类型等参数发送至分析模块。</span><br><span class="line"></span><br><span class="line">在index.php的112行附近，触发点击事件，进入main.php</span><br><span class="line"></span><br><span class="line">## main.php分析</span><br><span class="line"></span><br><span class="line">main.php是整个rips代码分析的开始部分</span><br><span class="line"></span><br><span class="line">配置文件引入:</span><br><span class="line"></span><br><span class="line">```php</span><br><span class="line">&lt;?php</span><br><span class="line">	include(&apos;config/general.php&apos;);			// 主要为各种参数的初始设置</span><br><span class="line">	include(&apos;config/sources.php&apos;);			// 可能从外部引入数据的函数或全局变量，如$_GET、file_get_contents()</span><br><span class="line">	include(&apos;config/tokens.php&apos;);			// 将代码分割成许多个token，以便于词法分析</span><br><span class="line">	include(&apos;config/securing.php&apos;);			// 根据函数的目的使用以及效果不同划分，如 htmlspecialchars 划入数组变量 $F_SECURING_XSS</span><br><span class="line">	include(&apos;config/sinks.php&apos;);			// 敏感函数汇总，根据函数对应的功能不同进行更进一步的划分</span><br><span class="line">	include(&apos;config/info.php&apos;);				// 对各种函数名添加对应注释，如sqlite_open()=&gt;&apos;using DBMS SQLite&apos;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>核心代码引入:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'lib/constructer.php'</span>); 		<span class="comment">// 类信息</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'lib/filer.php'</span>);				<span class="comment">// 仅定义了一个函数，用以获取指定路径下所有文件</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'lib/tokenizer.php'</span>);			<span class="comment">// prepare and fix token list</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'lib/analyzer.php'</span>);			<span class="comment">// string analyzers</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'lib/scanner.php'</span>);				<span class="comment">// provides class for scan</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'lib/printer.php'</span>);				<span class="comment">// output scan result</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'lib/searcher.php'</span>);			<span class="comment">// search functions</span></span><br></pre></td></tr></table></figure>
<p>结束引用部分，进入main.php文件的逻辑处理部分</p>
<h3 id="文件路径传入"><a class="markdownIt-Anchor" href="#文件路径传入"></a> 文件路径传入</h3>
<p>对传入的路径参数进行处理，如果传入参数为目录，则递归目录的文件信息，并赋值入变量，如果为单个文件，则只记录该文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'loc'</span>]))</span><br><span class="line">&#123;		</span><br><span class="line">	$location = realpath($_POST[<span class="string">'loc'</span>]);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(is_dir($location))</span><br><span class="line">	&#123;</span><br><span class="line">		$scan_subdirs = <span class="keyword">isset</span>($_POST[<span class="string">'subdirs'</span>]) ? $_POST[<span class="string">'subdirs'</span>] : <span class="keyword">false</span>;</span><br><span class="line">		$files = read_recursiv($location, $scan_subdirs);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(count($files) &gt; WARNFILES &amp;&amp; !<span class="keyword">isset</span>($_POST[<span class="string">'ignore_warning'</span>]))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'warning:'</span>.count($files));</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(is_file($location) &amp;&amp; in_array(substr($location, strrpos($location, <span class="string">'.'</span>)), $FILETYPES))</span><br><span class="line">	&#123;</span><br><span class="line">		$files[<span class="number">0</span>] = $location;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		$files = <span class="keyword">array</span>();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化扫描功能"><a class="markdownIt-Anchor" href="#初始化扫描功能"></a> 初始化扫描功能</h3>
<p>首先对各种参数进行初始化赋值，如各类计数变量等，随后根据传来的verbosity变量，即&quot;漏洞类型&quot;参数，对scan_functions数组进行赋值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($_POST[<span class="string">'search'</span>]))</span><br><span class="line">		&#123;</span><br><span class="line">			$user_functions = <span class="keyword">array</span>();</span><br><span class="line">			$user_functions_offset = <span class="keyword">array</span>();</span><br><span class="line">			$user_input = <span class="keyword">array</span>();</span><br><span class="line">			</span><br><span class="line">			$file_sinks_count = <span class="keyword">array</span>();</span><br><span class="line">			$count_xss=$count_sqli=$count_fr=$count_fa=$count_fi=$count_exec=$count_code=$count_eval=$count_xpath=$count_ldap=$count_con=$count_other=$count_pop=$count_inc=$count_inc_fail=$count_header=$count_sf=$count_ri=<span class="number">0</span>;</span><br><span class="line">			</span><br><span class="line">			$verbosity = <span class="keyword">isset</span>($_POST[<span class="string">'verbosity'</span>]) ? $_POST[<span class="string">'verbosity'</span>] : <span class="number">1</span>;</span><br><span class="line">			$scan_functions = <span class="keyword">array</span>();</span><br><span class="line">			$info_functions = Info::$F_INTEREST;</span><br><span class="line">			<span class="keyword">if</span>($verbosity != <span class="number">5</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">switch</span>($_POST[<span class="string">'vector'</span>])  <span class="comment">//确定待扫描函数</span></span><br><span class="line">				&#123;</span><br><span class="line">                    <span class="comment">//XSS</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'xss'</span>:			$scan_functions = $F_XSS; 			<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//header</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'httpheader'</span>:	$scan_functions = $F_HTTP_HEADER;	<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//session</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'fixation'</span>:	$scan_functions = $F_SESSION_FIXATION;	<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//代码执行类</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'code'</span>: 		$scan_functions = $F_CODE;			<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//反射</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'ri'</span>: 			$scan_functions = $F_REFLECTION;	<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//文件读取</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'file_read'</span>:	$scan_functions = $F_FILE_READ;		<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//可对文件产生影响</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'file_affect'</span>:	$scan_functions = $F_FILE_AFFECT;	<span class="keyword">break</span>;		</span><br><span class="line">                    <span class="comment">//文件包含</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'file_include'</span>:$scan_functions = $F_FILE_INCLUDE;	<span class="keyword">break</span>;	</span><br><span class="line">                    <span class="comment">//执行命令</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'exec'</span>:  		$scan_functions = $F_EXEC;			<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//执行SQL</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'database'</span>: 	$scan_functions = $F_DATABASE;		<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//XPATH注入</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'xpath'</span>:		$scan_functions = $F_XPATH;			<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//LDAP操作</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'ldap'</span>:		$scan_functions = $F_LDAP;			<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//协议注入</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'connect'</span>: 	$scan_functions = $F_CONNECT;		<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//其他的一些危险函数</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'other'</span>:		$scan_functions = $F_OTHER;			<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//POP链</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'unserialize'</span>:	&#123;</span><br><span class="line">										$scan_functions = $F_POP;				</span><br><span class="line">										$info_functions = Info::$F_INTEREST_POP;</span><br><span class="line">										$source_functions = <span class="keyword">array</span>(<span class="string">'unserialize'</span>);</span><br><span class="line">										$verbosity = <span class="number">2</span>;</span><br><span class="line">										&#125; </span><br><span class="line">										<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//客户端</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'client'</span>:</span><br><span class="line">						$scan_functions = array_merge(</span><br><span class="line">							$F_XSS,</span><br><span class="line">							$F_HTTP_HEADER,</span><br><span class="line">							$F_SESSION_FIXATION</span><br><span class="line">						);</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//服务端</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'server'</span>: </span><br><span class="line">						$scan_functions = array_merge( </span><br><span class="line">							$F_CODE,</span><br><span class="line">							$F_REFLECTION,</span><br><span class="line">							$F_FILE_READ,</span><br><span class="line">							$F_FILE_AFFECT,</span><br><span class="line">							$F_FILE_INCLUDE,</span><br><span class="line">							$F_EXEC,</span><br><span class="line">							$F_DATABASE,</span><br><span class="line">							$F_XPATH,</span><br><span class="line">							$F_LDAP,</span><br><span class="line">							$F_CONNECT,</span><br><span class="line">							$F_POP,</span><br><span class="line">							$F_OTHER</span><br><span class="line">						); <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//所有类型</span></span><br><span class="line">					<span class="keyword">case</span> <span class="string">'all'</span>:  </span><br><span class="line">					<span class="keyword">default</span>:</span><br><span class="line">						$scan_functions = array_merge(</span><br><span class="line">							$F_XSS,</span><br><span class="line">							$F_HTTP_HEADER,</span><br><span class="line">							$F_SESSION_FIXATION,</span><br><span class="line">							$F_CODE,</span><br><span class="line">							$F_REFLECTION,</span><br><span class="line">							$F_FILE_READ,</span><br><span class="line">							$F_FILE_AFFECT,</span><br><span class="line">							$F_FILE_INCLUDE,</span><br><span class="line">							$F_EXEC,</span><br><span class="line">							$F_DATABASE,</span><br><span class="line">							$F_XPATH,</span><br><span class="line">							$F_LDAP,</span><br><span class="line">							$F_CONNECT,</span><br><span class="line">							$F_POP,</span><br><span class="line">							$F_OTHER</span><br><span class="line">						); <span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>($_POST[<span class="string">'vector'</span>] !== <span class="string">'unserialize'</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				$source_functions = Sources::$F_OTHER_INPUT;</span><br><span class="line">				<span class="comment">// add file and database functions as tainting functions</span></span><br><span class="line">				<span class="keyword">if</span>( $verbosity &gt; <span class="number">1</span> &amp;&amp; $verbosity &lt; <span class="number">5</span> )</span><br><span class="line">				&#123;</span><br><span class="line">					$source_functions = array_merge(Sources::$F_OTHER_INPUT, Sources::$F_FILE_INPUT, Sources::$F_DATABASE_INPUT);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>
<h3 id="代码审计及结果输出"><a class="markdownIt-Anchor" href="#代码审计及结果输出"></a> 代码审计及结果输出</h3>
<p>Scanner类在171行附近进行实例化，并进行词法分析，输出结果至前端</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$scan = <span class="keyword">new</span> Scanner($file_scanning, $scan_functions, $info_functions, $source_functions);</span><br><span class="line">$scan-&gt;parse();</span><br><span class="line">$scanned_files[$file_scanning] = $scan-&gt;inc_map;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
<h3 id="流程部分总结"><a class="markdownIt-Anchor" href="#流程部分总结"></a> 流程部分总结</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: index.php</span><br><span class="line">op=&gt;operation: main.php(审计逻辑)</span><br><span class="line">e=&gt;end: main.php(前端输出)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">st-&gt;op-&gt;e</span><br></pre></td></tr></table></figure>

    </div>

    
</div>
    <div class="footer" id="footer">
    <p>Copyright © 2020 Meizj.
        <!-- <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label> -->
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="white">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">
<script src="/libs/jquery.min.js"></script>
<script src="/libs/highlight/highlight.pack.js"></script>
<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<!-- <script src="//unpkg.com/heti/umd/heti-addon.min.js"></script>
<script>
    const heti = new Heti('.heti');
    heti.autoSpacing();
</script> -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5JET59Z93Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5JET59Z93Q');
</script>
<script src="/js/js.js"></script>
<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>