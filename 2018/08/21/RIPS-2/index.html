<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <link rel="stylesheet" href="//unpkg.com/heti/umd/heti.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&family=Roboto+Serif:opsz,wght@8..144,100&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        梅子酒の笔记本
    </title>
    <link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">
    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css">
<link rel="alternate" href="/atom.xml" title="梅子酒の笔记本" type="application/atom+xml">
</head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            RIPS源码精读(二):扫描对象的实例化及token信息的生成
        </p>
        <hr>
    </div>
    <div class="post-content heti">
        <h1 id="rips源码精读二扫描对象的实例化及token信息的生成"><a class="markdownIt-Anchor" href="#rips源码精读二扫描对象的实例化及token信息的生成"></a> RIPS源码精读(二):扫描对象的实例化及token信息的生成</h1>
<h1 id="引言"><a class="markdownIt-Anchor" href="#引言"></a> 引言</h1>
<p>在main.php的171行附近,rips对<code>Scanner</code>类进行了实例化，并由此进入正式的分析流程.</p>
<h1 id="内容简介"><a class="markdownIt-Anchor" href="#内容简介"></a> 内容简介</h1>
<p>阅读rips关于token分析处理相关的源码,并分析对应的用途及处理逻辑.</p>
<h1 id="scanner类"><a class="markdownIt-Anchor" href="#scanner类"></a> Scanner类</h1>
<p>首先是调用<code>Scanner</code>类的构造函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scan = <span class="keyword">new</span> Scanner($file_scanning, $scan_functions, $info_functions, $source_functions);</span><br></pre></td></tr></table></figure>
<p>各参数说明如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$file_scanning:待扫描文件的文件名</span><br><span class="line"></span><br><span class="line">$scan_functions:待扫描的函数类型，由 main.php 中 $_POST[&apos;vector&apos;] 的值决定</span><br><span class="line"></span><br><span class="line">$info_functions:由 main.php 中 Info::$F_INTEREST 而来,是一个已定义的函数名数组</span><br><span class="line"></span><br><span class="line">$source_functions:由 main.php 中 Sources::$F_OTHER_INPUT 而来,是一个已定义的函数名数组</span><br></pre></td></tr></table></figure>
<h2 id="scanner类构造函数分析"><a class="markdownIt-Anchor" href="#scanner类构造函数分析"></a> Scanner类构造函数分析</h2>
<p>Scanner构造函数定义如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name, $scan_functions, $info_functions, $source_functions)</span></span></span><br></pre></td></tr></table></figure>
<p>首先是大量的变量初始赋值:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//直接传参获取的参数</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;file_name = $file_name; </span><br><span class="line"><span class="keyword">$this</span>-&gt;scan_functions = $scan_functions; </span><br><span class="line"><span class="keyword">$this</span>-&gt;info_functions = $info_functions; </span><br><span class="line"><span class="keyword">$this</span>-&gt;source_functions = $source_functions; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//......</span></span><br></pre></td></tr></table></figure>
<p>其中夹杂着<code>Analyzer</code>类的初始化,用于获取php的<code>include_path</code>配置</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;include_paths = Analyzer::get_ini_paths(ini_get(<span class="string">"include_path"</span>));</span><br></pre></td></tr></table></figure>
<p>紧接着便是根据文件生成token信息</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$tokenizer = <span class="keyword">new</span> Tokenizer(<span class="keyword">$this</span>-&gt;file_pointer);</span><br><span class="line"><span class="keyword">$this</span>-&gt;tokens = $tokenizer-&gt;tokenize(implode(<span class="string">''</span>,<span class="keyword">$this</span>-&gt;lines_pointer));</span><br><span class="line"><span class="keyword">unset</span>($tokenizer);</span><br></pre></td></tr></table></figure>
<p>在讲这几行作用之前,要先了解<code>token_get_all</code>函数</p>
<h2 id="token_get_all函数简单介绍"><a class="markdownIt-Anchor" href="#token_get_all函数简单介绍"></a> token_get_all()函数简单介绍</h2>
<p>php手册说明如下</p>
<blockquote>
<p>token_get_all() 解析提供的 source 源码字符，然后使用 Zend 引擎的语法分析器获取源码中的 PHP 语言的解析器代号</p>
</blockquote>
<p>函数定义</p>
<blockquote>
<p>array token_get_all ( string $source )</p>
</blockquote>
<p>示例代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="number">123</span>;&gt;</span><br></pre></td></tr></table></figure>
<p>token_get_all()处理语句</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">token_get_all(<span class="string">"&lt;?php echo 123;&gt;"</span>);</span><br></pre></td></tr></table></figure>
<p>处理结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; 376</span><br><span class="line">            [1] =&gt; &lt;?php</span><br><span class="line">            [2] =&gt; 1</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [1] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; 319</span><br><span class="line">            [1] =&gt; echo</span><br><span class="line">            [2] =&gt; 1</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [2] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; 379</span><br><span class="line">            [1] =&gt;</span><br><span class="line">            [2] =&gt; 1</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [3] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; 308</span><br><span class="line">            [1] =&gt; 123</span><br><span class="line">            [2] =&gt; 1</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [4] =&gt; ;</span><br><span class="line">    [5] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; 378</span><br><span class="line">            [1] =&gt; ?&gt;</span><br><span class="line">            [2] =&gt; 1</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>可以看到,代码被分割成了五段,其中除了第四段之外,每一段都分为三段.</p>
<p>我们设<code>$token=token_get_all(....)</code>,那么<code>$token[0]</code>便对应着</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; 376</span><br><span class="line">            [1] =&gt; &lt;?php</span><br><span class="line">            [2] =&gt; 1</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>则<code>$token[0][1]</code>对应<code>&lt;?php</code></p>
<p>那么下一个问题便是<code>$token[0]</code>对应数组中的三个值,分别代表什么意思,解释如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; 376  // token索引</span><br><span class="line">            [1] =&gt; &lt;?php  // 具体内容</span><br><span class="line">            [2] =&gt; 1  // 行号</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>我们可以使用token_name获得索引所对应的字面常量</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> token_name(<span class="number">376</span>);</span><br><span class="line"><span class="comment">//result =&gt; T_OPEN_TAG</span></span><br><span class="line"><span class="keyword">echo</span> token_name(<span class="number">319</span>)</span><br><span class="line"><span class="comment">//result =&gt; T_ECHO</span></span><br><span class="line"><span class="keyword">echo</span> token_name(<span class="number">308</span>);</span><br><span class="line"><span class="comment">//result =&gt; T_LNUMBER</span></span><br><span class="line"><span class="keyword">echo</span> token_name(<span class="number">378</span>)</span><br><span class="line"><span class="comment">//result =&gt; T_CLOSE_TAG</span></span><br></pre></td></tr></table></figure>
<p>以上便是对token_get_all函数大致介绍</p>
<h2 id="scanner类中token信息生成分析"><a class="markdownIt-Anchor" href="#scanner类中token信息生成分析"></a> Scanner类中token信息生成分析</h2>
<p>回到生成<code>token</code>信息的这几句</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$tokenizer = <span class="keyword">new</span> Tokenizer(<span class="keyword">$this</span>-&gt;file_pointer);</span><br><span class="line"><span class="keyword">$this</span>-&gt;tokens = $tokenizer-&gt;tokenize(implode(<span class="string">''</span>,<span class="keyword">$this</span>-&gt;lines_pointer));</span><br><span class="line"><span class="keyword">unset</span>($tokenizer);</span><br></pre></td></tr></table></figure>
<p><code>$tokenizer</code>由<code>Tokenizer</code>类实例化而来,构造函数如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename)</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来调用<code>tokenize</code>函数,跟进</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tokenize</span><span class="params">($code)</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;tokens = token_get_all($code);			</span><br><span class="line">    <span class="keyword">$this</span>-&gt;prepare_tokens();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;array_reconstruct_tokens();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;fix_tokens();	</span><br><span class="line">    <span class="keyword">$this</span>-&gt;fix_ternary();</span><br><span class="line">    <span class="comment">#die(print_r($this-&gt;tokens));</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;tokens;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出在<code>tokenize</code>调用了多个token分析相关的函数,完成token分析准备、重构等工作</p>
<h3 id="prepare_token函数分析"><a class="markdownIt-Anchor" href="#prepare_token函数分析"></a> prepare_token()函数分析</h3>
<p>跟进<code>$this-&gt;prepare_tokens()</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prepare_tokens</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>, $max=count(<span class="keyword">$this</span>-&gt;tokens); $i&lt;$max; $i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>( is_array(<span class="keyword">$this</span>-&gt;tokens[$i]) ) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>( in_array(<span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">0</span>], Tokens::$T_IGNORE) )</span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;tokens[$i]);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">0</span>] === T_CLOSE_TAG )</span><br><span class="line">                <span class="keyword">$this</span>-&gt;tokens[$i] = <span class="string">';'</span>;	</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">0</span>] === T_OPEN_TAG_WITH_ECHO )</span><br><span class="line">                <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">1</span>] = <span class="string">'echo'</span>;</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i] === <span class="string">'@'</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;tokens[$i]);</span><br><span class="line">        &#125;	</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i] === <span class="string">'&#123;'</span></span><br><span class="line">        &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i<span class="number">-1</span>]) &amp;&amp; ((is_array(<span class="keyword">$this</span>-&gt;tokens[$i<span class="number">-1</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i<span class="number">-1</span>][<span class="number">0</span>] === T_VARIABLE)</span><br><span class="line">        || <span class="keyword">$this</span>-&gt;tokens[$i<span class="number">-1</span>] === <span class="string">']'</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;tokens[$i] = <span class="string">'['</span>;</span><br><span class="line">            $f=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f] !== <span class="string">'&#125;'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                $f++;</span><br><span class="line">                <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f]))</span><br><span class="line">                &#123;</span><br><span class="line">                    addError(<span class="string">'Could not find closing brace of '</span>.<span class="keyword">$this</span>-&gt;tokens[$i<span class="number">-1</span>][<span class="number">1</span>].<span class="string">'&#123;&#125;.'</span>, array_slice(<span class="keyword">$this</span>-&gt;tokens, $i<span class="number">-1</span>, <span class="number">2</span>), <span class="keyword">$this</span>-&gt;tokens[$i<span class="number">-1</span>][<span class="number">2</span>], <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">                    <span class="keyword">break</span>;	</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;tokens[$i+$f] = <span class="string">']'</span>;</span><br><span class="line">        &#125;	</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// rearranged key index of tokens</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;tokens = array_values(<span class="keyword">$this</span>-&gt;tokens);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>prepare_token</code>函数中,大体上是由一个<code>for</code>循环与<code>return</code>语句组成,<code>for</code>循环为<code>prepare_token</code>的主要功能</p>
<p>首先对每个<code>token</code>判断是否为数组,这一判断的依据我们在上面已经提到,随后进入<code>in_array</code>,在第一个<code>in_array</code>中,紧接着是第二个<code>in_array</code>,这一步的主要作用为,通过<code>token索引</code>来判断是否为需要忽略的<code>token</code>,若为需要忽略token,则<code>unset</code></p>
<p>与第二个<code>in_array</code>处于同一判断级别的条件为判断是否为php的开始(<code>&lt;?=</code>)与闭合标签,若是,则替换为<code>;</code>或<code>echo</code></p>
<p>与第一个<code>in_array</code>处于同一判断级别的另两个条件为</p>
<ol>
<li><code>@</code>符号</li>
<li>该<code>token</code>信息为<code>{</code>,且下一<code>token</code>信息存在,<code>下一token信息为数组,下一token的索引对应变量</code>或<code>下一token为]</code></li>
</ol>
<p>在该<code>else if</code>语句中,首先会将本次循环对应的<code>token</code>信息的<code>{</code>替换为<code>[</code>,接着便是while循环,寻找下一个闭合的<code>}</code>符号,如果寻找不到则执行<code>addError</code></p>
<p>这个<code>else if</code>解释起来较为复杂繁琐,简单来讲便是将<code>$array{xxx}</code>格式的变量转换为<code>$array[xxx]</code></p>
<p>接下来便是结束循环语句,执行<code>return</code>语句</p>
<p>总结一下<code>prepare_token()</code>函数功能:</p>
<blockquote>
<p>去除无意义的符号,统一数组格式为<code>$array[xxx]</code>格式</p>
</blockquote>
<h3 id="array_reconstruct_tokens函数分析"><a class="markdownIt-Anchor" href="#array_reconstruct_tokens函数分析"></a> array_reconstruct_tokens函数分析</h3>
<p>在开始这里的分析前,我们先观察数组变量的<code>token</code>结构,php代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$array = <span class="keyword">array</span>();</span><br><span class="line">$array[<span class="number">0</span>] = [<span class="number">1</span>];</span><br><span class="line">$array[<span class="string">"meizj"</span>] = [<span class="string">"mei"</span>];</span><br></pre></td></tr></table></figure>
<p>得到的<code>token</code>信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">/Applications/MAMP/htdocs/aaa.php:18:</span><br><span class="line">array (size=35)</span><br><span class="line">  0 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 376</span><br><span class="line">      1 =&gt; string &apos;&lt;?php</span><br><span class="line">&apos; (length=6)</span><br><span class="line">      2 =&gt; int 1</span><br><span class="line">  1 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 379</span><br><span class="line">      1 =&gt; string &apos;</span><br><span class="line">&apos; (length=1)</span><br><span class="line">      2 =&gt; int 2</span><br><span class="line">  2 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 312</span><br><span class="line">      1 =&gt; string &apos;$array&apos; (length=6)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">  3 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 379</span><br><span class="line">      1 =&gt; string &apos; &apos; (length=1)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">  4 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  5 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 379</span><br><span class="line">      1 =&gt; string &apos; &apos; (length=1)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">  6 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 366</span><br><span class="line">      1 =&gt; string &apos;array&apos; (length=5)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">  7 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  8 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  9 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  10 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 379</span><br><span class="line">      1 =&gt; string &apos;</span><br><span class="line">&apos; (length=1)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">  11 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 312</span><br><span class="line">      1 =&gt; string &apos;$array&apos; (length=6)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">  12 =&gt; string &apos;[&apos; (length=1)</span><br><span class="line">  13 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 308</span><br><span class="line">      1 =&gt; string &apos;0&apos; (length=1)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">  14 =&gt; string &apos;]&apos; (length=1)</span><br><span class="line">  15 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 379</span><br><span class="line">      1 =&gt; string &apos; &apos; (length=1)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">  16 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  17 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 379</span><br><span class="line">      1 =&gt; string &apos; &apos; (length=1)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">  18 =&gt; string &apos;[&apos; (length=1)</span><br><span class="line">  19 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 308</span><br><span class="line">      1 =&gt; string &apos;1&apos; (length=1)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">  20 =&gt; string &apos;]&apos; (length=1)</span><br><span class="line">  21 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  22 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 379</span><br><span class="line">      1 =&gt; string &apos;</span><br><span class="line">&apos; (length=1)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">  23 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 312</span><br><span class="line">      1 =&gt; string &apos;$array&apos; (length=6)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  24 =&gt; string &apos;[&apos; (length=1)</span><br><span class="line">  25 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 318</span><br><span class="line">      1 =&gt; string &apos;&quot;meizj&quot;&apos; (length=7)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  26 =&gt; string &apos;]&apos; (length=1)</span><br><span class="line">  27 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 379</span><br><span class="line">      1 =&gt; string &apos; &apos; (length=1)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  28 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  29 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 379</span><br><span class="line">      1 =&gt; string &apos; &apos; (length=1)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  30 =&gt; string &apos;[&apos; (length=1)</span><br><span class="line">  31 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 318</span><br><span class="line">      1 =&gt; string &apos;&quot;mei&quot;&apos; (length=5)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  32 =&gt; string &apos;]&apos; (length=1)</span><br><span class="line">  33 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  34 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 379</span><br><span class="line">      1 =&gt; string &apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br></pre></td></tr></table></figure>
<p>从第13行开始,出现的token索引为:</p>
<blockquote>
<p>308  379  312 318</p>
</blockquote>
<p>分别对应的<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; T_LNUMBER:整型 </span><br><span class="line">&gt; T_WHITESPACE:空格</span><br><span class="line">&gt; T_VARIABLE:变量</span><br><span class="line">&gt; T_CONSTANT_ENCAPSED_STRING:字符串语法</span><br><span class="line"></span><br><span class="line">因此,根据行数与对应token索引的值可以明白键值的类型是可以由`T_CONSTANT_ENCAPSED_STRING`以及`T_LNUMBER`来表示的.</span><br><span class="line"></span><br><span class="line">有了这层基础,我们才能较好的去分析`array_reconstruct_tokens`</span><br><span class="line"></span><br><span class="line">随后进入`array_reconstruct_tokens`函数,函数源码如下:</span><br><span class="line"></span><br><span class="line">```php</span><br><span class="line"></span><br><span class="line">function array_reconstruct_tokens()</span><br><span class="line">&#123;	</span><br><span class="line">    for($i=0,$max=count($this-&gt;tokens); $i&lt;$max; $i++)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        if( is_array($this-&gt;tokens[$i]) &amp;&amp; $this-&gt;tokens[$i][0] === T_VARIABLE &amp;&amp; $this-&gt;tokens[$i+1] === &apos;[&apos; )</span><br><span class="line">        &#123;	</span><br><span class="line">            $this-&gt;tokens[$i][3] = array();</span><br><span class="line">            $has_more_keys = true;</span><br><span class="line">            $index = -1;</span><br><span class="line">            $c=2;</span><br><span class="line"></span><br><span class="line">            // loop until no more index found: array[1][2][3]</span><br><span class="line">            while($has_more_keys &amp;&amp; $index &lt; MAX_ARRAY_KEYS)</span><br><span class="line">            &#123;</span><br><span class="line">                $index++;</span><br><span class="line"></span><br><span class="line">                if(($this-&gt;tokens[$i+$c][0] === T_CONSTANT_ENCAPSED_STRING || $this-&gt;tokens[$i+$c][0] === T_LNUMBER || $this-&gt;tokens[$i+$c][0] === T_NUM_STRING || $this-&gt;tokens[$i+$c][0] === T_STRING) &amp;&amp; $this-&gt;tokens[$i+$c+1] === &apos;]&apos;)</span><br><span class="line">                &#123; 		</span><br><span class="line">                    unset($this-&gt;tokens[$i+$c-1]);</span><br><span class="line">                    $this-&gt;tokens[$i][3][$index] = str_replace(array(&apos;&quot;&apos;, &quot;&apos;&quot;), &apos;&apos;, $this-&gt;tokens[$i+$c][1]);</span><br><span class="line">                    unset($this-&gt;tokens[$i+$c]);</span><br><span class="line">                    unset($this-&gt;tokens[$i+$c+1]);</span><br><span class="line">                    $c+=2;</span><br><span class="line">                // save tokens of non-constant index as token-array for backtrace later	</span><br><span class="line">                &#125; else</span><br><span class="line">                &#123;</span><br><span class="line">                    $this-&gt;tokens[$i][3][$index] = array();</span><br><span class="line">                    $newbraceopen = 1;</span><br><span class="line">                    unset($this-&gt;tokens[$i+$c-1]);</span><br><span class="line">                    while($newbraceopen !== 0)</span><br><span class="line">                    &#123;	</span><br><span class="line">                        if( $this-&gt;tokens[$i+$c] === &apos;[&apos; )</span><br><span class="line">                        &#123;</span><br><span class="line">                            $newbraceopen++;</span><br><span class="line">                        &#125;</span><br><span class="line">                        else if( $this-&gt;tokens[$i+$c] === &apos;]&apos; )</span><br><span class="line">                        &#123;</span><br><span class="line">                            $newbraceopen--;</span><br><span class="line">                        &#125;</span><br><span class="line">                        else</span><br><span class="line">                        &#123;</span><br><span class="line">                            $this-&gt;tokens[$i][3][$index][] = $this-&gt;tokens[$i+$c];</span><br><span class="line">                        &#125;	</span><br><span class="line">                        unset($this-&gt;tokens[$i+$c]);</span><br><span class="line">                        $c++;</span><br><span class="line"></span><br><span class="line">                        if(!isset($this-&gt;tokens[$i+$c]))</span><br><span class="line">                        &#123;</span><br><span class="line">                            addError(&apos;Could not find closing bracket of &apos;.$this-&gt;tokens[$i][1].&apos;[].&apos;, array_slice($this-&gt;tokens, $i, 5), $this-&gt;tokens[$i][2], $this-&gt;filename);</span><br><span class="line">                            break;	</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    unset($this-&gt;tokens[$i+$c-1]);</span><br><span class="line">                &#125;</span><br><span class="line">                if($this-&gt;tokens[$i+$c] !== &apos;[&apos;)</span><br><span class="line">                    $has_more_keys = false;</span><br><span class="line">                $c++;	</span><br><span class="line">            &#125;	</span><br><span class="line"></span><br><span class="line">            $i+=$c-1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $this-&gt;tokens = array_values($this-&gt;tokens);		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>array_reconstruct_tokens</code>函数结构与<code>prepare_token</code>函数类似,其实不仅是这两个函数,在<code>tokenize</code>函数中出现的<code>fix_tokens</code>,<code>fix_ternary</code>结构都是类似的,从结构相似这个角度上我们也可以看出看出某些信息,即可能都是在处理统一结构相关的信息。</p>
<p>回到<code>array_reconstruct_tokens</code>函数</p>
<p>首先分析第一个<code>if</code>语句,判断要求为:</p>
<ol>
<li>该<code>token</code>信息为数组</li>
<li>该<code>token</code>的索引为变量类型</li>
<li>该<code>token</code>的下一个<code>token</code>信息为<code>[</code></li>
</ol>
<p>从这三个条件,我们可以很容易发现这是在寻找<code>数组</code>类型的变量,继续分析</p>
<p>在进入if语句后,将<code>$this-&gt;token[$i][3]</code>替换为了数组,随后又进行了三次赋值:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$has_more_keys = <span class="keyword">true</span>;</span><br><span class="line">$index = <span class="number">-1</span>;</span><br><span class="line">$c=<span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p>暂时不分析其各自含义,继续向下分析</p>
<p>接下来是一个<code>while</code>循环,判断条件有两个:</p>
<ol>
<li><code>$has_more_keys</code>是否为真</li>
<li><code>$index</code>小于<code>MAX_ARRAY_KEYS</code></li>
</ol>
<p>两者需要同时满足,才进入while循环.跟踪<code>MAX_ARRAY_KEYS</code>常量,发现是类似于数组维数的变量,定义如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'MAX_ARRAY_KEYS'</span>, <span class="number">10</span>);			<span class="comment">// maximum array key $array[1][2][3][4]..</span></span><br></pre></td></tr></table></figure>
<p>进入之后<code>while</code>循环,首先<code>$index</code>变量自增,随后是<code>if</code>语句,判断条件如下:</p>
<ol>
<li><code>token</code>索引的值需要为数组</li>
<li><code>token</code>索引的值需要为<code>T_CONSTANT_ENCAPSED_STRING</code>,<code>T_LNUMBER</code>,<code>T_NUM_STRING</code>,<code>T_STRING</code></li>
<li>下一个<code>token</code>对应的值为<code>]</code></li>
</ol>
<p>可以判断出,这是在寻找数组的键值部分</p>
<p>进入该<code>if</code>语句后,首先将上一个<code>token</code>信息消除,再将该<code>token</code>的值去掉单双引号存入<code>$this-&gt;token[$i+$c][3]</code>位置的数组.</p>
<p>进入该<code>if</code>语句对应的<code>else</code>语句中,与前面取<code>不变值作为index</code>不同,else语句中则是对<code>变值作为index</code>的收集</p>
<p>首先是赋值语句,对<code>token</code>新增了第四个键值,并初始化为数组:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">3</span>][$index] = <span class="keyword">array</span>();</span><br></pre></td></tr></table></figure>
<p>接下来对<code>$newbraceopen</code>赋值为<code>1</code>,该变量可理解为<code>[</code>出现的次数.</p>
<p>往下两行是<code>while</code>循环:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">while</span>($newbraceopen !== <span class="number">0</span>)</span><br><span class="line">&#123;	</span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i+$c] === <span class="string">'['</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        $newbraceopen++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i+$c] === <span class="string">']'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        $newbraceopen--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">3</span>][$index][] = <span class="keyword">$this</span>-&gt;tokens[$i+$c];</span><br><span class="line">    &#125;	</span><br><span class="line">    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$c]);</span><br><span class="line">    $c++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$c]))</span><br><span class="line">    &#123;</span><br><span class="line">        addError(<span class="string">'Could not find closing bracket of '</span>.<span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">1</span>].<span class="string">'[].'</span>, array_slice(<span class="keyword">$this</span>-&gt;tokens, $i, <span class="number">5</span>), <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">2</span>], <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        <span class="keyword">break</span>;	</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了上一个<code>if</code>的基础,我们可以轻易看出,该<code>while</code>语句作用为将数组的<code>值</code>存储在token信息的第四个键上.</p>
<p>到此为止,<code>array_reconstruct_tokens</code>函数的作用基本明了:</p>
<blockquote>
<p>将数组如由<code>$array[]</code>格式转换为<code>$token[i][3]</code>格式表示的数据</p>
</blockquote>
<h3 id="fix_tokens函数分析"><a class="markdownIt-Anchor" href="#fix_tokens函数分析"></a> fix_tokens()函数分析</h3>
<p><code>fix_token</code>函数定义非常长,考虑到篇幅问题就不放出了.</p>
<p>整个函数与上面类似,由<code>for</code>和<code>return</code>语句构成,跟入<code>for</code>语句.</p>
<p>首先是<code>if</code>语句,当前token信息为反引号时,则进入if语句.</p>
<p><code>if</code>语句中嵌套了<code>while</code>语句,可以发现<code>if</code>的条件和<code>while</code>的条件刚好可以构成由一对反引号包裹的变量.</p>
<p>而在<code>while</code>语句中的逻辑则是在取其行号,当<code>while</code>语句结束后,则进入行号的判断,若行号存在,则第二个反引号的位置被替换为<code>)</code>,第一个反引号的位置被替换为如下的token信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;tokens[$i] = array(T_STRING, &apos;backticks&apos;, $line_nr);</span><br></pre></td></tr></table></figure>
<p>在第一个<code>if</code>语句最后以<code>array_merger</code>收尾,语句如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;tokens = array_merge(</span><br><span class="line">array_slice(<span class="keyword">$this</span>-&gt;tokens, <span class="number">0</span>, $i+<span class="number">1</span>), </span><br><span class="line"><span class="keyword">array</span>(<span class="string">'('</span>), </span><br><span class="line">array_slice(<span class="keyword">$this</span>-&gt;tokens, $i+<span class="number">1</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>结合刚刚提到到,将第二个反引号替换为<code>)</code>,那么换个角度看,其实也缺失了一个<code>(</code>,为了补齐这个括号,通过使用将<code>token</code>先分段,再插入,再组合的方法达到补齐括号的效果.</p>
<p>因为<code>fix_token</code>的函数过长,因此每个<code>if</code>我都会总结一下作用,那么这个if的作用其实便是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将 `xxxx`  转换为   xxx()</span><br></pre></td></tr></table></figure>
<p>接下来进入<code>else if</code>.</p>
<p>首先是<code>if</code>语句,进入<code>if</code>语句的条件为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. T_IF</span><br><span class="line">2. T_ELSEIF</span><br><span class="line">3. T_FOR</span><br><span class="line">4. T_FOREACH</span><br><span class="line">5. T_WHILE</span><br><span class="line">6. 以上五个条件任意成立一个并且  $this-&gt;tokens[$i+1] === &apos;(&apos; 成立</span><br></pre></td></tr></table></figure>
<p>接下来是一个<code>while</code>语句,结合上面的经验,我们可以知道这其实是在对括号中的内容定位,然而并没有出现记录相关的操作,结合<code>T_IF</code>此类token信息,不难分析出这一步的<code>while</code>实质是跳过其中的条件语句.</p>
<p>接着<code>while</code>语句的为一个<code>if</code>语句,相关代码为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f] === <span class="string">':'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span>(<span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">0</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> T_IF:</span><br><span class="line">        <span class="keyword">case</span> T_ELSEIF: $endtoken = T_ENDIF; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> T_FOR: $endtoken = T_ENDFOR; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> T_FOREACH: $endtoken = T_ENDFOREACH; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> T_WHILE: $endtoken = T_ENDWHILE; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: $endtoken = <span class="string">';'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $c=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>( <span class="keyword">$this</span>-&gt;tokens[$i+$f+$c][<span class="number">0</span>] !== $endtoken)</span><br><span class="line">    &#123;</span><br><span class="line">        $c++;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f+$c]))</span><br><span class="line">        &#123;</span><br><span class="line">            addError(<span class="string">'Could not find end'</span>.<span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">1</span>].<span class="string">'; of alternate '</span>.<span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">1</span>].<span class="string">'-statement.'</span>, array_slice(<span class="keyword">$this</span>-&gt;tokens, $i, $f+<span class="number">1</span>), <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">2</span>], <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">            <span class="keyword">break</span>;	</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;wrapbraces($i+$f+<span class="number">1</span>, $c+<span class="number">1</span>, $i+$f+$c+<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入<code>if</code>的条件为:</p>
<ol>
<li><code>$this-&gt;tokens[$i+$f] === ':'</code></li>
</ol>
<p>而<code>if</code>语句则是switch语句,分别对应<code>T_IF</code>一类的条件语句,然而再结合前面的<code>$this-&gt;tokens[$i+$f] === ':'</code>这个条件则让人有点不解.</p>
<p>这一部分其实是php的替代语法.比如:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>($a&lt;<span class="number">0</span>): <span class="meta">?&gt;</span></span><br><span class="line"><span class="number">123</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>替代语法的语法结构与我们常用的语法结构不同这一点十分重要.</p>
<p>在<code>switch</code>语句中,设置了对应不同token的结束符号,而接下来的while语句则是不断寻找对应的结束符号的出现位置.</p>
<p>在最后出现了函数<code>wrapbraces</code>.跟入:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrapbraces</span><span class="params">($start, $between, $end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;tokens = array_merge(</span><br><span class="line">        array_slice(<span class="keyword">$this</span>-&gt;tokens, <span class="number">0</span>, $start), <span class="keyword">array</span>(<span class="string">'&#123;'</span>), </span><br><span class="line">        array_slice(<span class="keyword">$this</span>-&gt;tokens, $start, $between), <span class="keyword">array</span>(<span class="string">'&#125;'</span>),</span><br><span class="line">        array_slice(<span class="keyword">$this</span>-&gt;tokens, $end)</span><br><span class="line">    );	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与上面出现的<code>array_merge</code>作用类似,都是为了补齐语法结构,符合我们平常的使用习惯</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>($a&lt;<span class="number">0</span>) &#123; <span class="meta">?&gt;</span></span><br><span class="line">    <span class="number">123</span>   </span><br><span class="line"><span class="meta">&lt;?php</span> &#125;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>到这一步为止,语法结构补完.</p>
<p>对应的<code>else if</code>语句则为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f] !== <span class="string">'&#123;'</span> &amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i+$f] !== <span class="string">';'</span>)&#123;</span><br><span class="line">    $c=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f+$c] !== <span class="string">';'</span> &amp;&amp; $c&lt;$max)</span><br><span class="line">    &#123;</span><br><span class="line">        $c++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;wrapbraces($i+$f, $c+<span class="number">1</span>, $i+$f+$c+<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于我们已经跳过了判断的条件语句,那么此时<code>$token[$i+$f]</code>对应的其实是<code>{</code>,但是可以看到这里的<code>else if</code>判断条件便是<code>不为{ 且不为 ;</code>.</p>
<p>此类代码如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($a==<span class="number">1</span>) <span class="keyword">echo</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>于是在这个<code>else if</code>语句里出现了<code>while</code>循环用以寻找这个语句块的结尾,并通过<code>$this-&gt;wrapbraces</code>来补齐语法结构.</p>
<p>再跟入下一个</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>( </span><br><span class="line"><span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">0</span>] === T_ELSE </span><br><span class="line">&amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i+<span class="number">1</span>][<span class="number">0</span>] !== T_IF</span><br><span class="line">&amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i+<span class="number">1</span>] !== <span class="string">'&#123;'</span>)</span><br><span class="line">&#123;	</span><br><span class="line">    $f=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">while</span>( <span class="keyword">$this</span>-&gt;tokens[$i+$f] !== <span class="string">';'</span> &amp;&amp; $f&lt;$max)</span><br><span class="line">    &#123;		</span><br><span class="line">        $f++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;wrapbraces($i+<span class="number">1</span>, $f, $i+$f+<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>语法结构基本一样,根据条件判断,该语句是用来补全<code>else</code>结构的<code>{</code>.</p>
<p>再往下依然是<code>else if</code>,代码如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">0</span>] === T_SWITCH &amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i+<span class="number">1</span>] === <span class="string">'('</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $newbraceopen = <span class="number">1</span>;</span><br><span class="line">    $c=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">while</span>( $newbraceopen !== <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i + $c] === <span class="string">'('</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            $newbraceopen++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i + $c] === <span class="string">')'</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            $newbraceopen--;</span><br><span class="line">        &#125;					</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$c]) || <span class="keyword">$this</span>-&gt;tokens[$i + $c] === <span class="string">';'</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            addError(<span class="string">'Could not find closing parenthesis of switch-statement.'</span>, array_slice(<span class="keyword">$this</span>-&gt;tokens, $i, <span class="number">10</span>), <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">2</span>], <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">            <span class="keyword">break</span>;	</span><br><span class="line">        &#125;</span><br><span class="line">        $c++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// switch(): ... endswitch;</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i + $c] === <span class="string">':'</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        $f=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>( <span class="keyword">$this</span>-&gt;tokens[$i+$c+$f][<span class="number">0</span>] !== T_ENDSWITCH)</span><br><span class="line">        &#123;</span><br><span class="line">            $f++;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$c+$f]))</span><br><span class="line">            &#123;</span><br><span class="line">                addError(<span class="string">'Could not find endswitch; of alternate switch-statement.'</span>, array_slice(<span class="keyword">$this</span>-&gt;tokens, $i, $c+<span class="number">1</span>), <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">2</span>], <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">                <span class="keyword">break</span>;	</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;wrapbraces($i+$c+<span class="number">1</span>, $f+<span class="number">1</span>, $i+$c+$f+<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该<code>else if</code>语句进入的条件为<code>switch</code>语句,根据前面的经验,我们可以知道第一个<code>while</code>语句是用来寻找<code>swicth</code>的条件值,而下面的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i + $c] === <span class="string">':'</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        $f=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>( <span class="keyword">$this</span>-&gt;tokens[$i+$c+$f][<span class="number">0</span>] !== T_ENDSWITCH)</span><br><span class="line">        &#123;</span><br><span class="line">            $f++;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$c+$f]))</span><br><span class="line">            &#123;</span><br><span class="line">                addError(<span class="string">'Could not find endswitch; of alternate switch-statement.'</span>, array_slice(<span class="keyword">$this</span>-&gt;tokens, $i, $c+<span class="number">1</span>), <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">2</span>], <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">                <span class="keyword">break</span>;	</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;wrapbraces($i+$c+<span class="number">1</span>, $f+<span class="number">1</span>, $i+$c+$f+<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>则是用来寻找<code>switch</code>语句的结尾并使用<code>{}</code>包裹,使之形成一个代码块.</p>
<p>继续看向下一个<code>else if</code>块:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">0</span>] === T_CASE )</span><br><span class="line">&#123;</span><br><span class="line">    $e=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$e] !== <span class="string">':'</span> &amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i+$e] !== <span class="string">';'</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        $e++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$e]))</span><br><span class="line">        &#123;</span><br><span class="line">            addError(<span class="string">'Could not find : or ; after '</span>.<span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">1</span>].<span class="string">'-statement.'</span>, array_slice(<span class="keyword">$this</span>-&gt;tokens, $i, <span class="number">5</span>), <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">2</span>], <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">            <span class="keyword">break</span>;	</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $f=$e+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>((<span class="keyword">$this</span>-&gt;tokens[$i+$e] === <span class="string">':'</span> || <span class="keyword">$this</span>-&gt;tokens[$i+$e] === <span class="string">';'</span>)</span><br><span class="line">    &amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i+$f] !== <span class="string">'&#123;'</span> </span><br><span class="line">    &amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] !== T_CASE &amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] !== T_DEFAULT)</span><br><span class="line">    &#123;</span><br><span class="line">        $newbraceopen = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>($newbraceopen || (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f]) &amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i+$f] !== <span class="string">'&#125;'</span> </span><br><span class="line">        &amp;&amp; !(is_array(<span class="keyword">$this</span>-&gt;tokens[$i+$f]) </span><br><span class="line">        &amp;&amp; (<span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] === T_BREAK || <span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] === T_CASE </span><br><span class="line">        || <span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] === T_DEFAULT || <span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] === T_ENDSWITCH) ) ))</span><br><span class="line">        &#123;		</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f] === <span class="string">'&#123;'</span>)</span><br><span class="line">                $newbraceopen++;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f] === <span class="string">'&#125;'</span>)	</span><br><span class="line">                $newbraceopen--;</span><br><span class="line">            $f++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f]))</span><br><span class="line">            &#123;</span><br><span class="line">                addError(<span class="string">'Could not find ending of '</span>.<span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">1</span>].<span class="string">'-statement.'</span>, array_slice(<span class="keyword">$this</span>-&gt;tokens, $i, $e+<span class="number">5</span>), <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">2</span>], <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">                <span class="keyword">break</span>;	</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] === T_BREAK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f+<span class="number">1</span>] === <span class="string">';'</span>)</span><br><span class="line">                <span class="keyword">$this</span>-&gt;wrapbraces($i+$e+<span class="number">1</span>, $f-$e+<span class="number">1</span>, $i+$f+<span class="number">2</span>);</span><br><span class="line">            <span class="comment">// break 3;	</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;wrapbraces($i+$e+<span class="number">1</span>, $f-$e+<span class="number">2</span>, $i+$f+<span class="number">3</span>);</span><br><span class="line">        &#125;	</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;wrapbraces($i+$e+<span class="number">1</span>, $f-$e<span class="number">-1</span>, $i+$f);</span><br><span class="line">        &#125;	</span><br><span class="line">        $i++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类似的语法结构,使用<code>while</code>定位到冒号,跳过<code>case</code>条件,将<code>case xxx:yyyy</code>分割成<code>case xxx</code>、<code>:yyyy</code>两段.</p>
<p>随后开始处理第二段.</p>
<p>接着的是<code>if</code>语句,进入的条件为:</p>
<ol>
<li><code>$this-&gt;tokens[$i+$e]</code>为<code>:</code> 或  <code>$this-&gt;tokens[$i+$e]</code>为<code>;</code></li>
<li><code>$this-&gt;tokens[$i+$f]</code>不为<code>{</code></li>
<li><code>$this-&gt;tokens[$i+$f][0]</code>不为<code>T_CASE</code>或<code>T_DEFAULT</code></li>
</ol>
<p>在<code>if</code>语句继续包裹了一个条件要求较多的<code>while</code>语句,对应的条件如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(</span><br><span class="line"></span><br><span class="line">$newbraceopen </span><br><span class="line">|| </span><br><span class="line">    (</span><br><span class="line">    <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f]) </span><br><span class="line">    &amp;&amp; </span><br><span class="line">    <span class="keyword">$this</span>-&gt;tokens[$i+$f] !== <span class="string">'&#125;'</span> </span><br><span class="line">    &amp;&amp; </span><br><span class="line">        !(</span><br><span class="line">        is_array(<span class="keyword">$this</span>-&gt;tokens[$i+$f]) </span><br><span class="line">        &amp;&amp; </span><br><span class="line">            (</span><br><span class="line">            <span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] === T_BREAK </span><br><span class="line">            || </span><br><span class="line">            <span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] === T_CASE </span><br><span class="line">            || </span><br><span class="line">            <span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] === T_DEFAULT </span><br><span class="line">            || </span><br><span class="line">            <span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] === T_ENDSWITCH) </span><br><span class="line">            ) </span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p>即:</p>
<ol>
<li>$newbraceopen小于等于0</li>
<li><code>$this-&gt;tokens[$i+$f][0]</code>处的token不为<code>}</code>或<code>T_BREAK</code>,<code>T_CASE</code>,<code>T_DEFAULT</code>,<code>T_ENDSWITCH</code></li>
</ol>
<p><code>while</code>语句中的组成与上面差异不大,仍然是去定位在<code>while</code>语句中出现的这几个标签.</p>
<p>通过这一步操作,<code>swicth</code>语句下多个条件得以分开,而接下来的语句为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] === T_BREAK)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f+<span class="number">1</span>] === <span class="string">';'</span>)</span><br><span class="line">        <span class="keyword">$this</span>-&gt;wrapbraces($i+$e+<span class="number">1</span>, $f-$e+<span class="number">1</span>, $i+$f+<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;wrapbraces($i+$e+<span class="number">1</span>, $f-$e+<span class="number">2</span>, $i+$f+<span class="number">3</span>);</span><br><span class="line">&#125;	</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;wrapbraces($i+$e+<span class="number">1</span>, $f-$e<span class="number">-1</span>, $i+$f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一段主要作用为在<code>break</code>语句处加上<code>{}</code>,补全语法结构.</p>
<p>接下来是与上面判断为<code>case</code>同级的<code>else if</code>语句,代码如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">0</span>] === T_DEFAULT</span><br><span class="line">&amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i+<span class="number">2</span>] !== <span class="string">'&#123;'</span> )</span><br><span class="line">&#123;</span><br><span class="line">    $f=<span class="number">2</span>;</span><br><span class="line">    $newbraceopen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( <span class="keyword">$this</span>-&gt;tokens[$i+$f] !== <span class="string">';'</span> &amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i+$f] !== <span class="string">'&#125;'</span> || $newbraceopen )</span><br><span class="line">    &#123;		</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f] === <span class="string">'&#123;'</span>)</span><br><span class="line">            $newbraceopen++;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f] === <span class="string">'&#125;'</span>)	</span><br><span class="line">            $newbraceopen--;</span><br><span class="line">        $f++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f]))</span><br><span class="line">        &#123;</span><br><span class="line">            addError(<span class="string">'Could not find ending of '</span>.<span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">1</span>].<span class="string">'-statement.'</span>, array_slice(<span class="keyword">$this</span>-&gt;tokens, $i, <span class="number">5</span>), <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">2</span>], <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">            <span class="keyword">break</span>;	</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;wrapbraces($i+<span class="number">2</span>, $f<span class="number">-1</span>, $i+$f+<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该语句进入的条件为token索引信息对应为<code>T_DEFAULT</code>.</p>
<p>结合上面的分析经验,本段代码作用为将default的条件部分使用花括号包括,补全语法结构.</p>
<p>再往下为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">0</span>] === T_FUNCTION )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;tokens[$i+<span class="number">1</span>][<span class="number">1</span>] = strtolower(<span class="keyword">$this</span>-&gt;tokens[$i+<span class="number">1</span>][<span class="number">1</span>]);</span><br><span class="line">&#125;	</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">0</span>] === T_STRING &amp;&amp; <span class="keyword">$this</span>-&gt;tokens[$i+<span class="number">1</span>] === <span class="string">'('</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">1</span>] = strtolower(<span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一段是将函数名全部小写,并没有太多要详细说明的内容.接下来是<code>else if</code>语句:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">0</span>] === T_DO )</span><br><span class="line">&#123;</span><br><span class="line">    $f=<span class="number">2</span>;</span><br><span class="line">    $otherDOs = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//找到最外层的while,跳过内层while</span></span><br><span class="line">    <span class="keyword">while</span>( <span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] !== T_WHILE || $otherDOs )</span><br><span class="line">    &#123;		</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] === T_DO)</span><br><span class="line">            $otherDOs++;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f][<span class="number">0</span>] === T_WHILE)</span><br><span class="line">            $otherDOs--;</span><br><span class="line">        $f++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tokens[$i+$f]))</span><br><span class="line">        &#123;</span><br><span class="line">            addError(<span class="string">'Could not find WHILE of DO-WHILE-statement.'</span>, array_slice(<span class="keyword">$this</span>-&gt;tokens, $i, <span class="number">5</span>), <span class="keyword">$this</span>-&gt;tokens[$i][<span class="number">2</span>], <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">            <span class="keyword">break</span>;	</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 补齐花括号</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i+<span class="number">1</span>] !== <span class="string">'&#123;'</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;wrapbraces($i+<span class="number">1</span>, $f<span class="number">-1</span>, $i+$f);</span><br><span class="line">        <span class="comment">// by adding braces we added two new tokens</span></span><br><span class="line">        $f+=<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $d=<span class="number">1</span>;</span><br><span class="line">    <span class="comment">//$max=count($this-&gt;tokens)  因此该while语句为在寻找临近do-while的距离</span></span><br><span class="line">    <span class="keyword">while</span>( <span class="keyword">$this</span>-&gt;tokens[$i+$f+$d] !== <span class="string">';'</span> \&amp;\&amp; $d&lt;$max )</span><br><span class="line">    &#123;</span><br><span class="line">        $d++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将token中的do-while变为while</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;tokens = array_merge(</span><br><span class="line">        array_slice(<span class="keyword">$this</span>-&gt;tokens, <span class="number">0</span>, $i), <span class="comment">// before DO </span></span><br><span class="line">        array_slice(<span class="keyword">$this</span>-&gt;tokens, $i+$f, $d), <span class="comment">// WHILE condition</span></span><br><span class="line">        array_slice(<span class="keyword">$this</span>-&gt;tokens, $i+<span class="number">1</span>, $f<span class="number">-1</span>), <span class="comment">// DO WHILE loop tokens</span></span><br><span class="line">        array_slice(<span class="keyword">$this</span>-&gt;tokens, $i+$f+$d+<span class="number">1</span>, count(<span class="keyword">$this</span>-&gt;tokens)) <span class="comment">// rest of tokens without while condition</span></span><br><span class="line">    );	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在前面的基础上,我们再来分析这一段代码便简单许多,简化一下描述便是:该段代码用以整合do-while语句,补齐语法结构并将<code>do-while</code>精简为<code>while</code>.</p>
<p>最后返回精简过的<code>token</code>信息:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;tokens = array_values(<span class="keyword">$this</span>-&gt;tokens);</span><br></pre></td></tr></table></figure>
<h3 id="fix_ternary函数分析"><a class="markdownIt-Anchor" href="#fix_ternary函数分析"></a> fix_ternary函数分析</h3>
<p>从函数名分析分析,该函数作用为处理三元操作符,使其变为我们常见的语法习惯.大体结构仍然为<code>for</code>循环搭配<code>return</code>语句.</p>
<p>首先是<code>if</code>语句判断是否为<code>?</code>,为真则进入.并在进入后立即删除问号,随后判断在问号之前的符号是否为<code>)</code>,为真则进入,随后又删除反括号.并通过while语句将问号之前的使用括号包裹的token信息删除,直到找到最外层括号,结束while语句.</p>
<p>随后是if语句:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;tokens[$i-$f] === <span class="string">'!'</span> </span><br><span class="line">|| (</span><br><span class="line">    is_array(<span class="keyword">$this</span>-&gt;tokens[$i-$f]) </span><br><span class="line">    &amp;&amp; (<span class="keyword">$this</span>-&gt;tokens[$i-$f][<span class="number">0</span>] === T_STRING    </span><br><span class="line">        || <span class="keyword">$this</span>-&gt;tokens[$i-$f][<span class="number">0</span>] === T_EMPTY </span><br><span class="line">        || <span class="keyword">$this</span>-&gt;tokens[$i-$f][<span class="number">0</span>] === T_ISSET</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;tokens[$i-$f]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该段if语句满足以下条件之一即可进行删除token信息处理:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. $this-&gt;tokens[$i-$f] 为 !</span><br><span class="line">2. $this-&gt;tokens[$i-$f] 为 字符串、is_empty()、isset()</span><br></pre></td></tr></table></figure>
<p>接着进入与上面if同级的else if语句中:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(in_array(<span class="keyword">$this</span>-&gt;tokens[$i<span class="number">-2</span>][<span class="number">0</span>], Tokens::$T_ASSIGNMENT) || in_array(<span class="keyword">$this</span>-&gt;tokens[$i<span class="number">-2</span>][<span class="number">0</span>], Tokens::$T_OPERATOR) )</span><br></pre></td></tr></table></figure>
<p>可以看出,仅当<code>$this-&gt;tokens[$i-2][0]</code>为指定的token信息时,才会进入接下来的操作,而指定的token信息为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. $T_ASSIGNMENT    // 赋值符</span><br><span class="line">2. $T_OPERATOR      // 操作符</span><br></pre></td></tr></table></figure>
<p>其中,<code>$T_ASSIGNMENT</code>为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> $T_ASSIGNMENT = <span class="keyword">array</span>(</span><br><span class="line">    T_AND_EQUAL,</span><br><span class="line">    T_CONCAT_EQUAL,</span><br><span class="line">    T_DIV_EQUAL,</span><br><span class="line">    T_MINUS_EQUAL,</span><br><span class="line">    T_MOD_EQUAL,</span><br><span class="line">    T_MUL_EQUAL,</span><br><span class="line">    T_OR_EQUAL,</span><br><span class="line">    T_PLUS_EQUAL,</span><br><span class="line">    T_SL_EQUAL,</span><br><span class="line">    T_SR_EQUAL,</span><br><span class="line">    T_XOR_EQUAL</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>而<code>$T_OPERATOR</code>为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> $T_OPERATOR = <span class="keyword">array</span>(</span><br><span class="line">    T_IS_EQUAL,</span><br><span class="line">    T_IS_GREATER_OR_EQUAL,</span><br><span class="line">    T_IS_IDENTICAL,</span><br><span class="line">    T_IS_NOT_EQUAL,</span><br><span class="line">    T_IS_NOT_IDENTICAL,</span><br><span class="line">    T_IS_SMALLER_OR_EQUAL</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>而在接下来的操作中,rips删除了<code>$this-&gt;tokens[$i-1]</code>以及<code>$this-&gt;tokens[$i-2]</code>的token信息,这里删除<code>-1</code>与<code>-2</code>位置的token是因为上面的操作符通常都是成对出现的,如<code>T_AND_EQUAL</code>对应的操作符为<code>&amp;=</code>,因此需要删除<code>$i-1</code>与<code>$i-2</code>处的token才能保证操作符被删除干净.</p>
<p>而接下来的<code>while</code>语句则与前面的作用相同,都是用以删除在目标位置前,包裹在括号内的内容以及某几个特定的<code>token</code>信息.</p>
<p>随后进行最后的一次if判断,判断是否条件部分为单独的一个变量,如是,则删除.</p>
<p>最终返回token信息,至此,rips的<code>token</code>分析过程结束</p>
<h2 id="scanner效果展示"><a class="markdownIt-Anchor" href="#scanner效果展示"></a> Scanner效果展示</h2>
<p>我们自定义待扫描文件内容为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$a = $_GET[<span class="string">'a'</span>];</span><br><span class="line">$b = $_POST[<span class="string">'b'</span>];</span><br><span class="line">$c = <span class="keyword">array</span>(<span class="string">"c"</span>=&gt;<span class="string">"c"</span>,<span class="string">"d"</span>=&gt;<span class="string">"d"</span>);</span><br><span class="line">$d = [<span class="string">'1'</span>,<span class="string">'2'</span>];</span><br><span class="line"><span class="comment">// xxxxxxx</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">`ls`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($a==<span class="string">"1"</span>) $b=<span class="string">"2"</span>;</span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">isset</span>($c)?<span class="string">"aa"</span>:<span class="string">"bb"</span>;</span><br></pre></td></tr></table></figure>
<p>分别在<code>prepare_token</code>,<code>array_reconstruct_tokens</code>,<code>fix_tokens</code>,<code>fix_ternary</code>函数尾处添加var_dump函数,并在<code>tokenize</code>函数尾处写入<code>die()</code></p>
<p>首先输出的token为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">0|1|/Applications/MAMP/htdocs/aaa.php|0| 0|1|/Applications/MAMP/htdocs/aaa.php (tokenizing)|0|</span><br><span class="line">/Applications/MAMP/htdocs/rips/lib/tokenizer.php:92:</span><br><span class="line">array (size=60)</span><br><span class="line">  0 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$a&apos; (length=2)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">  1 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  2 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$_GET&apos; (length=5)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">  3 =&gt; string &apos;[&apos; (length=1)</span><br><span class="line">  4 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&apos;a&apos;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">  5 =&gt; string &apos;]&apos; (length=1)</span><br><span class="line">  6 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  7 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$b&apos; (length=2)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">  8 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  9 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$_POST&apos; (length=6)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">  10 =&gt; string &apos;[&apos; (length=1)</span><br><span class="line">  11 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&apos;b&apos;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">  12 =&gt; string &apos;]&apos; (length=1)</span><br><span class="line">  13 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  14 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$c&apos; (length=2)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  15 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  16 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 368</span><br><span class="line">      1 =&gt; string &apos;array&apos; (length=5)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  17 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  18 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;c&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  19 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 268</span><br><span class="line">      1 =&gt; string &apos;=&gt;&apos; (length=2)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  20 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;c&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  21 =&gt; string &apos;,&apos; (length=1)</span><br><span class="line">  22 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;d&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  23 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 268</span><br><span class="line">      1 =&gt; string &apos;=&gt;&apos; (length=2)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  24 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;d&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  25 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  26 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  27 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$d&apos; (length=2)</span><br><span class="line">      2 =&gt; int 6</span><br><span class="line">  28 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  29 =&gt; string &apos;[&apos; (length=1)</span><br><span class="line">  30 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&apos;1&apos;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 6</span><br><span class="line">  31 =&gt; string &apos;,&apos; (length=1)</span><br><span class="line">  32 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&apos;2&apos;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 6</span><br><span class="line">  33 =&gt; string &apos;]&apos; (length=1)</span><br><span class="line">  34 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  35 =&gt; string &apos;`&apos; (length=1)</span><br><span class="line">  36 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 322</span><br><span class="line">      1 =&gt; string &apos;ls&apos; (length=2)</span><br><span class="line">      2 =&gt; int 9</span><br><span class="line">  37 =&gt; string &apos;`&apos; (length=1)</span><br><span class="line">  38 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  39 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 327</span><br><span class="line">      1 =&gt; string &apos;if&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  40 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  41 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$a&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  42 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 285</span><br><span class="line">      1 =&gt; string &apos;==&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  43 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;1&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  44 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  45 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$b&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  46 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  47 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;2&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  48 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  49 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$a&apos; (length=2)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  50 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  51 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 358</span><br><span class="line">      1 =&gt; string &apos;isset&apos; (length=5)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  52 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  53 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$c&apos; (length=2)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  54 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  55 =&gt; string &apos;?&apos; (length=1)</span><br><span class="line">  56 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;aa&quot;&apos; (length=4)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  57 =&gt; string &apos;:&apos; (length=1)</span><br><span class="line">  58 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;bb&quot;&apos; (length=4)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  59 =&gt; string &apos;;&apos;</span><br></pre></td></tr></table></figure>
<p>随后经过<code>array_reconstruct_tokens</code>函数处理,重写了数组相关的<code>token</code>信息:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"> /Applications/MAMP/htdocs/rips/lib/tokenizer.php:454:</span><br><span class="line">array (size=54)</span><br><span class="line">  0 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$a&apos; (length=2)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">  1 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  2 =&gt; </span><br><span class="line">    array (size=4)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$_GET&apos; (length=5)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">      3 =&gt; </span><br><span class="line">        array (size=1)</span><br><span class="line">          0 =&gt; string &apos;a&apos; (length=1)</span><br><span class="line">  3 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  4 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$b&apos; (length=2)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">  5 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  6 =&gt; </span><br><span class="line">    array (size=4)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$_POST&apos; (length=6)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">      3 =&gt; </span><br><span class="line">        array (size=1)</span><br><span class="line">          0 =&gt; string &apos;b&apos; (length=1)</span><br><span class="line">  7 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  8 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$c&apos; (length=2)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  9 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  10 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 368</span><br><span class="line">      1 =&gt; string &apos;array&apos; (length=5)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  11 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  12 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;c&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  13 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 268</span><br><span class="line">      1 =&gt; string &apos;=&gt;&apos; (length=2)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  14 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;c&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  15 =&gt; string &apos;,&apos; (length=1)</span><br><span class="line">  16 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;d&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  17 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 268</span><br><span class="line">      1 =&gt; string &apos;=&gt;&apos; (length=2)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  18 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;d&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  19 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  20 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  21 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$d&apos; (length=2)</span><br><span class="line">      2 =&gt; int 6</span><br><span class="line">  22 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  23 =&gt; string &apos;[&apos; (length=1)</span><br><span class="line">  24 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&apos;1&apos;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 6</span><br><span class="line">  25 =&gt; string &apos;,&apos; (length=1)</span><br><span class="line">  26 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&apos;2&apos;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 6</span><br><span class="line">  27 =&gt; string &apos;]&apos; (length=1)</span><br><span class="line">  28 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  29 =&gt; string &apos;`&apos; (length=1)</span><br><span class="line">  30 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 322</span><br><span class="line">      1 =&gt; string &apos;ls&apos; (length=2)</span><br><span class="line">      2 =&gt; int 9</span><br><span class="line">  31 =&gt; string &apos;`&apos; (length=1)</span><br><span class="line">  32 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  33 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 327</span><br><span class="line">      1 =&gt; string &apos;if&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  34 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  35 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$a&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  36 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 285</span><br><span class="line">      1 =&gt; string &apos;==&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  37 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;1&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  38 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  39 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$b&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  40 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  41 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;2&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  42 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  43 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$a&apos; (length=2)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  44 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  45 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 358</span><br><span class="line">      1 =&gt; string &apos;isset&apos; (length=5)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  46 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  47 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$c&apos; (length=2)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  48 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  49 =&gt; string &apos;?&apos; (length=1)</span><br><span class="line">  50 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;aa&quot;&apos; (length=4)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  51 =&gt; string &apos;:&apos; (length=1)</span><br><span class="line">  52 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;bb&quot;&apos; (length=4)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  53 =&gt; string &apos;;&apos; (length=1)</span><br></pre></td></tr></table></figure>
<p>再经过<code>fix_tokens</code>处理,统一了部分token信息的写法(如对if语句统一使用花括号的标示形式)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">/Applications/MAMP/htdocs/rips/lib/tokenizer.php:379:</span><br><span class="line">array (size=57)</span><br><span class="line">  0 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$a&apos; (length=2)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">  1 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  2 =&gt; </span><br><span class="line">    array (size=4)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$_GET&apos; (length=5)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">      3 =&gt; </span><br><span class="line">        array (size=1)</span><br><span class="line">          0 =&gt; string &apos;a&apos; (length=1)</span><br><span class="line">  3 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  4 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$b&apos; (length=2)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">  5 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  6 =&gt; </span><br><span class="line">    array (size=4)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$_POST&apos; (length=6)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">      3 =&gt; </span><br><span class="line">        array (size=1)</span><br><span class="line">          0 =&gt; string &apos;b&apos; (length=1)</span><br><span class="line">  7 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  8 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$c&apos; (length=2)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  9 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  10 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 368</span><br><span class="line">      1 =&gt; string &apos;array&apos; (length=5)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  11 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  12 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;c&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  13 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 268</span><br><span class="line">      1 =&gt; string &apos;=&gt;&apos; (length=2)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  14 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;c&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  15 =&gt; string &apos;,&apos; (length=1)</span><br><span class="line">  16 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;d&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  17 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 268</span><br><span class="line">      1 =&gt; string &apos;=&gt;&apos; (length=2)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  18 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;d&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  19 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  20 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  21 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$d&apos; (length=2)</span><br><span class="line">      2 =&gt; int 6</span><br><span class="line">  22 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  23 =&gt; string &apos;[&apos; (length=1)</span><br><span class="line">  24 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&apos;1&apos;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 6</span><br><span class="line">  25 =&gt; string &apos;,&apos; (length=1)</span><br><span class="line">  26 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&apos;2&apos;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 6</span><br><span class="line">  27 =&gt; string &apos;]&apos; (length=1)</span><br><span class="line">  28 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  29 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 319</span><br><span class="line">      1 =&gt; string &apos;backticks&apos; (length=9)</span><br><span class="line">      2 =&gt; int 9</span><br><span class="line">  30 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  31 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 322</span><br><span class="line">      1 =&gt; string &apos;ls&apos; (length=2)</span><br><span class="line">      2 =&gt; int 9</span><br><span class="line">  32 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  33 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  34 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 327</span><br><span class="line">      1 =&gt; string &apos;if&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  35 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  36 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$a&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  37 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 285</span><br><span class="line">      1 =&gt; string &apos;==&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  38 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;1&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  39 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  40 =&gt; string &apos;&#123;&apos; (length=1)</span><br><span class="line">  41 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$b&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  42 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  43 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;2&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  44 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  45 =&gt; string &apos;&#125;&apos; (length=1)</span><br><span class="line">  46 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$a&apos; (length=2)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  47 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  48 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 358</span><br><span class="line">      1 =&gt; string &apos;isset&apos; (length=5)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  49 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  50 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$c&apos; (length=2)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  51 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  52 =&gt; string &apos;?&apos; (length=1)</span><br><span class="line">  53 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;aa&quot;&apos; (length=4)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  54 =&gt; string &apos;:&apos; (length=1)</span><br><span class="line">  55 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;bb&quot;&apos; (length=4)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  56 =&gt; string &apos;;&apos; (length=1)</span><br></pre></td></tr></table></figure>
<p>最终经过<code>fix_ternary</code>函数处理,是三元运算符的表达形式得到重写(<code>$a=isset($c)?&quot;aa&quot;:&quot;bb&quot;;</code>  =&gt; <code>$a=&quot;aa&quot;:&quot;bb&quot;</code>):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line">/Applications/MAMP/htdocs/rips/lib/tokenizer.php:558:</span><br><span class="line">array (size=52)</span><br><span class="line">  0 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$a&apos; (length=2)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">  1 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  2 =&gt; </span><br><span class="line">    array (size=4)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$_GET&apos; (length=5)</span><br><span class="line">      2 =&gt; int 3</span><br><span class="line">      3 =&gt; </span><br><span class="line">        array (size=1)</span><br><span class="line">          0 =&gt; string &apos;a&apos; (length=1)</span><br><span class="line">  3 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  4 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$b&apos; (length=2)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">  5 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  6 =&gt; </span><br><span class="line">    array (size=4)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$_POST&apos; (length=6)</span><br><span class="line">      2 =&gt; int 4</span><br><span class="line">      3 =&gt; </span><br><span class="line">        array (size=1)</span><br><span class="line">          0 =&gt; string &apos;b&apos; (length=1)</span><br><span class="line">  7 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  8 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$c&apos; (length=2)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  9 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  10 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 368</span><br><span class="line">      1 =&gt; string &apos;array&apos; (length=5)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  11 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  12 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;c&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  13 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 268</span><br><span class="line">      1 =&gt; string &apos;=&gt;&apos; (length=2)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  14 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;c&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  15 =&gt; string &apos;,&apos; (length=1)</span><br><span class="line">  16 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;d&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  17 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 268</span><br><span class="line">      1 =&gt; string &apos;=&gt;&apos; (length=2)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  18 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;d&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 5</span><br><span class="line">  19 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  20 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  21 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$d&apos; (length=2)</span><br><span class="line">      2 =&gt; int 6</span><br><span class="line">  22 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  23 =&gt; string &apos;[&apos; (length=1)</span><br><span class="line">  24 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&apos;1&apos;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 6</span><br><span class="line">  25 =&gt; string &apos;,&apos; (length=1)</span><br><span class="line">  26 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&apos;2&apos;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 6</span><br><span class="line">  27 =&gt; string &apos;]&apos; (length=1)</span><br><span class="line">  28 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  29 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 319</span><br><span class="line">      1 =&gt; string &apos;backticks&apos; (length=9)</span><br><span class="line">      2 =&gt; int 9</span><br><span class="line">  30 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  31 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 322</span><br><span class="line">      1 =&gt; string &apos;ls&apos; (length=2)</span><br><span class="line">      2 =&gt; int 9</span><br><span class="line">  32 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  33 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  34 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 327</span><br><span class="line">      1 =&gt; string &apos;if&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  35 =&gt; string &apos;(&apos; (length=1)</span><br><span class="line">  36 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$a&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  37 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 285</span><br><span class="line">      1 =&gt; string &apos;==&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  38 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;1&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  39 =&gt; string &apos;)&apos; (length=1)</span><br><span class="line">  40 =&gt; string &apos;&#123;&apos; (length=1)</span><br><span class="line">  41 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$b&apos; (length=2)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  42 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  43 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;2&quot;&apos; (length=3)</span><br><span class="line">      2 =&gt; int 11</span><br><span class="line">  44 =&gt; string &apos;;&apos; (length=1)</span><br><span class="line">  45 =&gt; string &apos;&#125;&apos; (length=1)</span><br><span class="line">  46 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 320</span><br><span class="line">      1 =&gt; string &apos;$a&apos; (length=2)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  47 =&gt; string &apos;=&apos; (length=1)</span><br><span class="line">  48 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;aa&quot;&apos; (length=4)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  49 =&gt; string &apos;:&apos; (length=1)</span><br><span class="line">  50 =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; int 323</span><br><span class="line">      1 =&gt; string &apos;&quot;bb&quot;&apos; (length=4)</span><br><span class="line">      2 =&gt; int 13</span><br><span class="line">  51 =&gt; string &apos;;&apos; (length=1)</span><br></pre></td></tr></table></figure>
<h2 id="流程总结"><a class="markdownIt-Anchor" href="#流程总结"></a> 流程总结</h2>
<ol>
<li>通过<code>prepare_token</code>生成初始token信息</li>
<li>通过<code>array_reconstruct_tokens</code>函数重写数组相关token信息</li>
<li>通过<code>fix_tokens</code>修复大量写法不统一的语句</li>
<li>用过<code>fix_ternary</code>统一三元运算符的表达形式</li>
</ol>
<p>通过以上四步,我们可以得到大致处理好的token信息,而对于漏洞的扫描也是建立在上面这四步生成的token信息基础上的.</p>

    </div>

    
</div>
    <div class="footer" id="footer">
    <p>Copyright © 2020 Meizj.
        <!-- <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label> -->
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="white">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">
<script src="/libs/jquery.min.js"></script>
<script src="/libs/highlight/highlight.pack.js"></script>
<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script src="//unpkg.com/heti/umd/heti-addon.min.js"></script>
<script>
    const heti = new Heti('.heti');
    heti.autoSpacing();
  </script>
<script src="/js/js.js"></script>
<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>